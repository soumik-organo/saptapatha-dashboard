<!DOCTYPE html>
<!-- saved from url=(0065)file:///C:/Users/ORGSYS127/Downloads/Saptapatha_Full_Tracker.html -->
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Saptapatha â€” Sustainability Tracker</title>
<link href="./Saptapatha â€” Sustainability Tracker_files/css2" rel="stylesheet">
<script src="./Saptapatha â€” Sustainability Tracker_files/chart.umd.min.js.download"></script>
<script src="./Saptapatha â€” Sustainability Tracker_files/xlsx.full.min.js.download"></script>
<style>
:root{
  --bg:#0b1512;--bg2:#0f1e18;--bg3:#152820;--panel:#1a3028;--panel2:#1e3830;
  --border:#2a4a3a;--border2:#3a5a48;
  --accent:#2dff8a;--amber:#ffb340;--red:#ff5252;--blue:#4db8ff;--purple:#b07dff;
  --text:#e8f5ef;--text2:#9cbfaf;--text3:#6a9a80;
  --mono:'DM Mono',monospace;--sans:'Outfit',sans-serif;
}
*{margin:0;padding:0;box-sizing:border-box;}
body{background:var(--bg);color:var(--text);font-family:var(--sans);min-height:100vh;overflow-x:hidden;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• DROP SCREEN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#drop-screen{position:fixed;inset:0;background:var(--bg);z-index:999;display:flex;align-items:center;justify-content:center;flex-direction:column;padding:40px;}
.drop-card{background:var(--panel);border:1px solid var(--border);border-radius:24px;padding:48px 40px;max-width:540px;width:100%;text-align:center;}
.drop-zone{border:2px dashed var(--border2);border-radius:16px;padding:44px 28px;margin:24px 0;cursor:pointer;transition:all 0.2s;position:relative;}
.drop-zone:hover,.drop-zone.dragging{border-color:var(--accent);background:rgba(45,255,138,0.04);}
.drop-icon{font-size:48px;margin-bottom:14px;display:block;animation:float 3s ease-in-out infinite;}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-7px)}}
.drop-title{font-size:18px;font-weight:700;margin-bottom:6px;}
.drop-sub{font-size:13px;color:var(--text3);}
.drop-input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;}
.drop-logo{font-size:32px;margin-bottom:10px;}
.drop-brand{font-size:22px;font-weight:800;margin-bottom:4px;}
.drop-tagline{font-size:12px;color:var(--text3);margin-bottom:4px;}
.drop-hint{background:var(--bg3);border-radius:10px;padding:14px 16px;font-size:12px;color:var(--text3);line-height:1.7;text-align:left;border-left:3px solid var(--accent);margin-top:16px;}
.drop-hint strong{color:var(--accent);}
.drop-or{display:flex;align-items:center;gap:12px;color:var(--text3);font-size:12px;margin:4px 0;}
.drop-or::before,.drop-or::after{content:'';flex:1;height:1px;background:var(--border);}
.manual-start-btn{width:100%;padding:14px;background:transparent;border:1px solid var(--border2);border-radius:10px;color:var(--text2);font-size:14px;font-weight:600;cursor:pointer;font-family:var(--sans);transition:all 0.2s;}
.manual-start-btn:hover{border-color:var(--accent);color:var(--accent);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOADING â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.loading-screen{display:none;position:fixed;inset:0;background:var(--bg);z-index:1000;align-items:center;justify-content:center;flex-direction:column;gap:16px;}
.loading-screen.show{display:flex;}
.loader-ring{width:56px;height:56px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;}
@keyframes spin{to{transform:rotate(360deg)}}
.loader-text{font-family:var(--mono);font-size:12px;color:var(--text3);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.header{background:linear-gradient(135deg,#0f1e18,#152820,#0d1a14);border-bottom:1px solid var(--border);padding:0 28px;position:sticky;top:0;z-index:100;}
.header-inner{display:flex;align-items:center;justify-content:space-between;height:60px;max-width:1600px;margin:0 auto;}
.logo-area{display:flex;align-items:center;gap:12px;}
.logo-mark{width:34px;height:34px;background:conic-gradient(from 0deg,var(--accent),#00e5a0,#00c4b4,var(--accent));border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:16px;animation:spin-slow 12s linear infinite;}
@keyframes spin-slow{to{transform:rotate(360deg)}}
.logo-text{font-size:16px;font-weight:700;}
.logo-sub{font-size:10px;color:var(--text3);font-family:var(--mono);letter-spacing:1px;text-transform:uppercase;}
.header-right{display:flex;align-items:center;gap:10px;}
.file-badge{background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:4px 10px;font-family:var(--mono);font-size:10px;color:var(--text3);max-width:200px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.period-badge{background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:4px 12px;font-family:var(--mono);font-size:11px;color:var(--accent);letter-spacing:1px;}
.header-btn{display:flex;align-items:center;gap:6px;padding:7px 14px;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;font-family:var(--sans);border:none;transition:all 0.2s;white-space:nowrap;}
.btn-entry{background:var(--accent);color:#0b1512;}
.btn-entry:hover{opacity:0.88;}
.btn-drop{background:var(--bg3);border:1px solid var(--border2)!important;color:var(--text2);}
.btn-drop:hover{border-color:var(--accent)!important;color:var(--accent);}
.btn-change{background:transparent;border:1px solid var(--border)!important;color:var(--text3);}
.btn-change:hover{border-color:var(--border2)!important;color:var(--text2);}
.btn-clear{background:transparent;border:1px solid rgba(255,82,82,0.35)!important;color:rgba(255,82,82,0.65);}
.btn-clear:hover{border-color:var(--red)!important;color:var(--red);background:rgba(255,82,82,0.07);}
.btn-github{background:transparent;border:1px solid rgba(77,184,255,0.4)!important;color:rgba(77,184,255,0.75);}
.btn-github:hover{border-color:var(--blue)!important;color:var(--blue);background:rgba(77,184,255,0.07);}
.btn-github.synced{border-color:rgba(45,255,138,0.5)!important;color:var(--accent);}
.btn-export{background:transparent;border:1px solid var(--border2)!important;color:var(--text3);}
.btn-export:hover{border-color:var(--text2)!important;color:var(--text2);}

/* â”€â”€ GitHub / Export / Import modal â”€â”€ */
.gh-modal{display:none;position:fixed;inset:0;background:rgba(11,21,18,0.92);z-index:2000;align-items:center;justify-content:center;}
.gh-modal.show{display:flex;}
.gh-box{background:var(--bg2);border:1px solid var(--border2);border-radius:16px;padding:32px 28px;width:420px;max-width:95vw;animation:cardIn 0.2s ease;}
.gh-title{font-size:15px;font-weight:700;color:var(--text);margin-bottom:6px;}
.gh-sub{font-size:11px;color:var(--text3);font-family:var(--mono);margin-bottom:22px;line-height:1.6;}
.gh-field{margin-bottom:14px;}
.gh-field label{display:block;font-size:10px;color:var(--text3);font-family:var(--mono);text-transform:uppercase;letter-spacing:.8px;margin-bottom:5px;}
.gh-field input{width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text);font-family:var(--mono);font-size:12px;outline:none;transition:border-color .15s;}
.gh-field input:focus{border-color:var(--blue);}
.gh-field input::placeholder{color:var(--text3);}
.gh-actions{display:flex;gap:10px;margin-top:20px;}
.gh-btn{flex:1;padding:10px;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;border:none;font-family:var(--sans);transition:all .2s;}
.gh-btn-primary{background:var(--blue);color:#0b1512;}
.gh-btn-primary:hover{opacity:.88;}
.gh-btn-cancel{background:transparent;border:1px solid var(--border2);color:var(--text2);}
.gh-btn-cancel:hover{border-color:var(--text2);}
.gh-status{font-size:11px;font-family:var(--mono);padding:8px 12px;border-radius:6px;margin-top:12px;display:none;}
.gh-status.show{display:block;}
.gh-status.ok{background:rgba(45,255,138,0.1);color:var(--accent);border:1px solid rgba(45,255,138,0.2);}
.gh-status.err{background:rgba(255,82,82,0.1);color:var(--red);border:1px solid rgba(255,82,82,0.2);}
.gh-status.loading{background:rgba(77,184,255,0.1);color:var(--blue);border:1px solid rgba(77,184,255,0.2);}
.gh-divider{height:1px;background:var(--border);margin:20px 0;}
.gh-hint{font-size:10px;color:var(--text3);font-family:var(--mono);line-height:1.7;background:var(--bg3);padding:10px 12px;border-radius:8px;border-left:2px solid var(--blue);}
.gh-hint a{color:var(--blue);text-decoration:none;}
.gh-hint a:hover{text-decoration:underline;}

/* Clear confirm modal */
#clearModal{display:none;position:fixed;inset:0;background:rgba(11,21,18,0.88);z-index:2000;align-items:center;justify-content:center;}
#clearModal.show{display:flex;}
.clear-modal-box{background:var(--bg2);border:1px solid var(--border2);border-radius:14px;padding:32px 28px;width:340px;text-align:center;animation:cardIn 0.2s ease;}
.clear-modal-title{font-size:16px;font-weight:700;font-family:var(--sans);color:var(--text);margin-bottom:8px;}
.clear-modal-sub{font-size:12px;color:var(--text3);font-family:var(--mono);margin-bottom:24px;line-height:1.6;}
.clear-modal-actions{display:flex;gap:10px;justify-content:center;}
.clear-confirm-btn{padding:9px 22px;border-radius:8px;font-size:12px;font-weight:700;cursor:pointer;border:none;font-family:var(--sans);}
.clear-cancel-btn{padding:9px 22px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;background:transparent;border:1px solid var(--border2);color:var(--text2);font-family:var(--sans);}
.clear-cancel-btn:hover{border-color:var(--text2);}
.clear-confirm-btn{background:var(--red);color:#fff;}
.clear-confirm-btn:hover{opacity:0.85;}
.clear-checkboxes{text-align:left;margin-bottom:20px;display:flex;flex-direction:column;gap:8px;}
.clear-check{display:flex;align-items:center;gap:8px;font-size:12px;color:var(--text2);font-family:var(--mono);cursor:pointer;}
.clear-check input{accent-color:var(--red);width:14px;height:14px;cursor:pointer;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• NAV â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.nav-tabs{background:var(--bg2);border-bottom:1px solid var(--border);padding:0 28px;display:flex;gap:2px;overflow-x:auto;scrollbar-width:none;}
.nav-tabs::-webkit-scrollbar{display:none;}
.nav-tab{padding:12px 18px;font-size:12px;font-weight:500;color:var(--text3);cursor:pointer;border:none;background:none;border-bottom:2px solid transparent;white-space:nowrap;transition:all 0.2s;font-family:var(--sans);}
.nav-tab:hover{color:var(--text2);}
.nav-tab.active{color:var(--accent);border-bottom-color:var(--accent);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.main{max-width:1600px;margin:0 auto;padding:24px 28px;}
.page{display:none;animation:fadeIn 0.25s ease;}
.page.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• COMPONENTS â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.section-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:2px;color:var(--text3);margin-bottom:14px;display:flex;align-items:center;gap:8px;}
.section-title::after{content:'';flex:1;height:1px;background:var(--border);}

.kpi-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;margin-bottom:24px;}
.kpi-card{background:var(--panel);border:1px solid var(--border);border-radius:11px;padding:18px;position:relative;overflow:hidden;transition:border-color 0.2s,transform 0.2s;animation:cardIn 0.35s ease both;}
.kpi-card:hover{border-color:var(--border2);transform:translateY(-1px);}
@keyframes cardIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.kpi-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--card-accent,var(--accent));}
.kpi-label{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;font-family:var(--mono);}
.kpi-value{font-size:26px;font-weight:700;font-family:var(--mono);color:var(--text);line-height:1;margin-bottom:5px;}
.kpi-unit{font-size:11px;color:var(--text3);margin-bottom:8px;}
.kpi-icon{position:absolute;top:14px;right:14px;font-size:20px;opacity:0.45;}
.tag{display:inline-flex;align-items:center;padding:2px 7px;border-radius:4px;font-size:10px;font-weight:600;font-family:var(--mono);}
.tag-green{background:rgba(45,255,138,0.12);color:var(--accent);}
.tag-amber{background:rgba(255,179,64,0.12);color:var(--amber);}
.tag-red{background:rgba(255,82,82,0.12);color:var(--red);}
.tag-grey{background:rgba(255,255,255,0.06);color:var(--text3);}
.tag-blue{background:rgba(77,184,255,0.12);color:var(--blue);}

.chart-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-bottom:24px;}
.chart-panel{background:var(--panel);border:1px solid var(--border);border-radius:11px;padding:20px;}
.chart-panel.wide{grid-column:span 2;}
.chart-title{font-size:12px;font-weight:600;color:var(--text2);margin-bottom:16px;display:flex;justify-content:space-between;align-items:center;}
.chart-title span{font-size:10px;color:var(--text3);font-family:var(--mono);}
.chart-wrap{position:relative;height:190px;}
.chart-wrap.tall{height:240px;}
.donut-center{position:relative;}
.donut-label{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;pointer-events:none;}
.donut-label .big{font-size:20px;font-weight:700;font-family:var(--mono);color:var(--text);}
.donut-label .small{font-size:10px;color:var(--text3);font-family:var(--mono);}

.pillars-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:10px;margin-bottom:24px;}
.pillar-card{background:var(--panel);border:1px solid var(--border);border-radius:11px;padding:16px 12px;text-align:center;cursor:pointer;transition:all 0.2s;}
.pillar-card:hover{border-color:var(--border2);background:var(--panel2);transform:translateY(-2px);}
.pillar-emoji{font-size:24px;margin-bottom:8px;display:block;}
.pillar-name{font-size:10px;font-weight:700;color:var(--text3);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px;}
.pillar-score{font-size:18px;font-weight:700;font-family:var(--mono);margin-bottom:5px;}
.pillar-bar-bg{height:3px;background:var(--border);border-radius:2px;margin-bottom:6px;}
.pillar-bar-fill{height:100%;border-radius:2px;transition:width 1s cubic-bezier(0.4,0,0.2,1);}
.pillar-status{font-size:9px;color:var(--text3);font-family:var(--mono);}

.data-table{width:100%;border-collapse:collapse;font-size:12px;}
.data-table th{text-align:left;padding:9px 12px;font-size:10px;font-weight:600;text-transform:uppercase;letter-spacing:1px;color:var(--text3);border-bottom:1px solid var(--border);font-family:var(--mono);}
.data-table td{padding:10px 12px;border-bottom:1px solid rgba(42,74,58,0.35);color:var(--text2);font-family:var(--mono);font-size:11px;}
.data-table tr:hover td{background:rgba(45,255,138,0.02);}
.data-table tr:last-child td{border-bottom:none;}
.num{text-align:right;}

.month-filter{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:18px;}
.month-btn{background:var(--bg3);border:1px solid var(--border);border-radius:20px;padding:4px 13px;font-size:10px;font-family:var(--mono);color:var(--text3);cursor:pointer;transition:all 0.15s;}
.month-btn.active{background:var(--accent);color:#0b1512;border-color:var(--accent);font-weight:700;}

.progress-row{margin-bottom:12px;}
.progress-label{display:flex;justify-content:space-between;margin-bottom:4px;font-size:11px;color:var(--text2);}
.progress-label span{font-family:var(--mono);color:var(--text3);font-size:10px;}
.progress-bg{height:5px;background:var(--border);border-radius:3px;overflow:hidden;}
.progress-fill{height:100%;border-radius:3px;transition:width 1.2s cubic-bezier(0.4,0,0.2,1);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• GLOBAL DROP OVERLAY â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#global-drop-overlay{display:none;position:fixed;inset:0;background:rgba(11,21,18,0.92);z-index:500;align-items:center;justify-content:center;flex-direction:column;gap:14px;border:3px dashed var(--accent);}
#global-drop-overlay.show{display:flex;}
.overlay-icon{font-size:56px;animation:float 1.5s ease-in-out infinite;}
.overlay-text{font-size:20px;font-weight:700;color:var(--accent);}
.overlay-sub{font-size:13px;color:var(--text3);font-family:var(--mono);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ENTRY DRAWER â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#entry-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.55);z-index:300;opacity:0;pointer-events:none;transition:opacity 0.25s;}
#entry-overlay.open{opacity:1;pointer-events:all;}
#entry-drawer{
  position:fixed;top:0;right:0;height:100vh;width:520px;
  background:var(--bg2);border-left:1px solid var(--border);
  z-index:301;display:flex;flex-direction:column;
  transform:translateX(100%);transition:transform 0.3s cubic-bezier(0.4,0,0.2,1);
  overflow:hidden;
}
#entry-drawer.open{transform:translateX(0);}

.drawer-header{
  padding:20px 24px 0;border-bottom:1px solid var(--border);
  background:linear-gradient(135deg,#0f1e18,#152820);flex-shrink:0;
}
.drawer-title-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.drawer-title{font-size:16px;font-weight:800;}
.drawer-title span{color:var(--accent);}
.drawer-close{background:none;border:none;color:var(--text3);font-size:20px;cursor:pointer;padding:4px;line-height:1;transition:color 0.15s;}
.drawer-close:hover{color:var(--text);}

/* Month row */
.drawer-month-row{display:flex;align-items:center;gap:10px;padding-bottom:16px;}
.drawer-month-row label{font-size:11px;color:var(--text3);font-family:var(--mono);white-space:nowrap;}
.month-input{
  flex:1;background:var(--bg3);border:1px solid var(--border2);border-radius:8px;
  padding:8px 12px;color:var(--text);font-family:var(--mono);font-size:12px;
  outline:none;transition:border-color 0.15s;
}
.month-input:focus{border-color:var(--accent);}
.month-input::placeholder{color:var(--text3);}
.month-select-existing{
  background:var(--bg3);border:1px solid var(--border);border-radius:8px;
  padding:8px 10px;color:var(--text2);font-family:var(--mono);font-size:11px;
  cursor:pointer;outline:none;transition:border-color 0.15s;
}
.month-select-existing:focus{border-color:var(--accent);}

/* Pillar tabs in drawer */
.drawer-pillar-tabs{display:flex;gap:0;overflow-x:auto;scrollbar-width:none;border-bottom:1px solid var(--border);}
.drawer-pillar-tabs::-webkit-scrollbar{display:none;}
.dp-tab{
  padding:10px 14px;font-size:11px;font-weight:600;cursor:pointer;
  border:none;background:none;color:var(--text3);white-space:nowrap;
  border-bottom:2px solid transparent;transition:all 0.15s;font-family:var(--sans);
}
.dp-tab:hover{color:var(--text2);}
.dp-tab.active{color:var(--accent);border-bottom-color:var(--accent);}
.dp-tab.has-data::after{content:'â—';font-size:6px;color:var(--accent);vertical-align:super;margin-left:3px;}

/* Drawer body */
.drawer-body{flex:1;overflow-y:auto;padding:20px 24px;}
.drawer-body::-webkit-scrollbar{width:4px;}
.drawer-body::-webkit-scrollbar-track{background:var(--bg2);}
.drawer-body::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}

/* Pillar panels */
.dp-panel{display:none;}
.dp-panel.active{display:block;}

/* Form fields */
.field-group{margin-bottom:20px;}
.field-group-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--text3);margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--border);font-family:var(--mono);}
.field-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;}
.field-row.single{grid-template-columns:1fr;}
.field-row.triple{grid-template-columns:1fr 1fr 1fr;}
.field{display:flex;flex-direction:column;gap:4px;}
.field label{font-size:10px;color:var(--text3);font-family:var(--mono);text-transform:uppercase;letter-spacing:0.8px;}
.field input,.field select{
  background:var(--bg3);border:1px solid var(--border);border-radius:7px;
  padding:9px 11px;color:var(--text);font-family:var(--mono);font-size:12px;
  outline:none;transition:border-color 0.15s,background 0.15s;width:100%;
}
.field input:focus,.field select:focus{border-color:var(--accent);background:var(--panel);}
.field input::placeholder{color:var(--text3);}
.field select{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='10' height='6'%3E%3Cpath d='M0 0l5 6 5-6z' fill='%236a9a80'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 10px center;}
.field select option{background:var(--bg3);}

/* Computed preview */
.computed-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
.computed-chip{background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:5px 10px;font-family:var(--mono);font-size:11px;color:var(--text2);}
.computed-chip strong{color:var(--accent);}

/* Mini table inside drawer */
.dt{width:100%;border-collapse:collapse;margin-top:8px;}
.dt th{font-size:9px;font-family:var(--mono);font-weight:600;letter-spacing:.8px;text-transform:uppercase;color:var(--text3);padding:5px 5px 7px;border-bottom:1px solid var(--border);text-align:center;}
.dt th:first-child{text-align:left;}
.dt td{padding:4px 4px;border-bottom:1px solid rgba(255,255,255,0.03);vertical-align:middle;}
.dt td:first-child{font-size:10px;font-family:var(--mono);color:var(--text2);padding-right:8px;white-space:nowrap;}
.dt td .mini-num,.dt td .mini-sel,.dt td .mini-txt{
  width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:5px;
  padding:4px 6px;color:var(--text);font-family:var(--mono);font-size:10px;
  outline:none;transition:border-color .12s;
}
.dt td .mini-num:focus,.dt td .mini-sel:focus,.dt td .mini-txt:focus{border-color:var(--accent);}
.dt td .mini-sel{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='5'%3E%3Cpath d='M0 0l4 5 4-5z' fill='%236a9a80'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 6px center;padding-right:18px;}
.dt .residue-cell{color:var(--amber);font-size:10px;font-family:var(--mono);text-align:center;min-width:44px;}
.dt .var-cell{font-size:10px;font-family:var(--mono);text-align:center;min-width:44px;}

/* Drawer footer */
.drawer-footer{
  padding:16px 24px;border-top:1px solid var(--border);
  background:var(--bg2);flex-shrink:0;
  display:flex;align-items:center;gap:10px;
}
.save-btn{
  flex:1;padding:13px;background:var(--accent);color:#0b1512;
  border:none;border-radius:9px;font-size:14px;font-weight:800;
  cursor:pointer;font-family:var(--sans);transition:opacity 0.2s;
  display:flex;align-items:center;justify-content:center;gap:8px;
}
.save-btn:hover{opacity:0.88;}
.clear-btn{
  padding:12px 16px;background:transparent;border:1px solid var(--border2);
  border-radius:9px;font-size:12px;color:var(--text3);cursor:pointer;
  font-family:var(--mono);transition:all 0.2s;
}
.clear-btn:hover{border-color:var(--red);color:var(--red);}
.save-feedback{font-size:11px;color:var(--accent);font-family:var(--mono);display:none;}
.save-feedback.show{display:block;animation:fadeIn 0.2s ease;}

/* Saved entries list */
.entry-list{margin-top:6px;}
.entry-item{
  display:flex;align-items:center;justify-content:space-between;
  padding:8px 12px;background:var(--bg3);border-radius:7px;margin-bottom:6px;
  font-size:11px;font-family:var(--mono);
}
.entry-month{color:var(--accent);font-weight:500;}
.entry-source{color:var(--text3);font-size:10px;}
.entry-del{background:none;border:none;color:var(--text3);cursor:pointer;font-size:14px;padding:0 4px;transition:color 0.15s;}
.entry-del:hover{color:var(--red);}
.entry-edit{background:none;border:none;color:var(--text3);cursor:pointer;font-size:11px;padding:0 6px;transition:color 0.15s;}
.entry-edit:hover{color:var(--accent);}

/* Toast */
#toast{
  position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(20px);
  background:var(--panel2);border:1px solid var(--accent);border-radius:10px;
  padding:12px 22px;font-size:13px;font-family:var(--mono);color:var(--accent);
  z-index:9999;opacity:0;transition:all 0.3s;pointer-events:none;white-space:nowrap;
}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• EMPTY STATE â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.empty-state{text-align:center;padding:48px 24px;color:var(--text3);}
.empty-icon{font-size:40px;margin-bottom:12px;}
.empty-text{font-size:14px;color:var(--text2);margin-bottom:6px;}
.empty-sub{font-size:12px;font-family:var(--mono);}
.empty-cta{display:inline-flex;align-items:center;gap:6px;margin-top:16px;padding:10px 20px;background:var(--accent);color:#0b1512;border:none;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;font-family:var(--sans);}

::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:var(--bg2);}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}
.footer{text-align:center;padding:24px;color:var(--text3);font-size:10px;font-family:var(--mono);border-top:1px solid var(--border);margin-top:32px;letter-spacing:0.5px;}
</style>
</head>
<body>

<!-- TOAST -->
<div id="toast"></div>

<!-- LOADING -->
<div class="loading-screen" id="loadingScreen">
  <div class="loader-ring"></div>
  <div class="loader-text" id="loaderText">Reading Excel fileâ€¦</div>
</div>

<!-- GLOBAL DROP OVERLAY -->
<div id="global-drop-overlay">
  <div class="overlay-icon">ğŸ“‚</div>
  <div class="overlay-text">Drop to update dashboard</div>
  <div class="overlay-sub">Release to load new Excel file</div>
</div>

<!-- â•â•â•â•â•â• DROP SCREEN â•â•â•â•â•â• -->
<div id="drop-screen">
  <div class="drop-card">
    <div class="drop-logo">ğŸŒ¿</div>
    <div class="drop-brand">Saptapatha Tracker</div>
    <div class="drop-tagline">7 Pillars Â· 182 Villas Â· OFM Community</div>

    <div class="drop-zone" id="dropZone">
      <input type="file" class="drop-input" id="fileInput" accept=".xlsx,.xls" onchange="handleFile(this.files[0])">
      <span class="drop-icon">ğŸ“Š</span>
      <div class="drop-title">Drop your Excel file here</div>
      <div class="drop-sub">or click to browse</div>
    </div>

    <div class="drop-or">or</div>
    <button class="manual-start-btn" onclick="startManual()">âœï¸ Enter data manually instead</button>

    <div class="drop-hint"><strong>Works with your existing file.</strong> Drop any month's Saptapatha Excel â€” dashboard populates instantly. Or use manual entry to type data directly.</div>
  </div>
</div>

<!-- â•â•â•â•â•â• DASHBOARD â•â•â•â•â•â• -->
<div id="dashboard" style="display:none">

  <header class="header">
    <div class="header-inner">
      <div class="logo-area">
        <div class="logo-mark">ğŸŒ¿</div>
        <div>
          <div class="logo-text">Saptapatha</div>
          <div class="logo-sub">Sustainability Intelligence</div>
        </div>
      </div>
      <div class="header-right">
        <div class="file-badge" id="fileBadge">Manual Data</div>
        <div class="period-badge" id="periodBadge">2026</div>
        <button class="header-btn btn-export" onclick="exportJSON()" title="Export data as JSON">â¬‡ï¸ Export</button>
        <label class="header-btn btn-export" style="cursor:pointer;" title="Import JSON backup">
          â¬†ï¸ Import <input type="file" accept=".json" style="display:none" onchange="importJSON(this)">
        </label>
        <button class="header-btn btn-github" id="ghBtn" onclick="openGHModal()" title="Sync with GitHub">â˜ï¸ GitHub</button>
        <button class="header-btn btn-entry" onclick="openDrawer()">âœï¸ Enter Data</button>
        <label class="header-btn btn-drop" style="cursor:pointer;border:1px solid var(--border2);">
          ğŸ“‚ Load Excel <input type="file" accept=".xlsx,.xls" style="display:none" onchange="handleFile(this.files[0])">
        </label>
        <button class="header-btn btn-clear" onclick="openClearModal()" title="Clear all data">ğŸ—‘ï¸ Clear</button>
      </div>
    </div>
  </header>

  <nav class="nav-tabs">
    <button class="nav-tab active" onclick="showPage(&#39;executive&#39;,this)">ğŸ“Š Executive</button>
    <button class="nav-tab" onclick="showPage(&#39;energy&#39;,this)">âš¡ Energy</button>
    <button class="nav-tab" onclick="showPage(&#39;water&#39;,this)">ğŸ’§ Water</button>
    <button class="nav-tab" onclick="showPage(&#39;food&#39;,this)">ğŸŒ± Food</button>
    <button class="nav-tab" onclick="showPage(&#39;earth&#39;,this)">ğŸŒ Earth</button>
    <button class="nav-tab" onclick="showPage(&#39;air&#39;,this)">ğŸ’¨ Air</button>
    <button class="nav-tab" onclick="showPage(&#39;people&#39;,this)">ğŸ‘¥ People</button>
    <button class="nav-tab" onclick="showPage(&#39;shelter&#39;,this)">ğŸ  Shelter</button>
  </nav>

  <main class="main">

    <!-- EXECUTIVE -->
    <div id="page-executive" class="page active">
      <div class="section-title">Seven Pillars â€” Overview</div>
      <div class="pillars-grid" id="pillarsGrid"></div>
      <div class="chart-grid">
        <div class="chart-panel"><div class="chart-title">Energy Mix <span id="execELbl"></span></div>
          <div class="chart-wrap donut-center"><canvas id="execEDonut"></canvas>
            <div class="donut-label"><div class="big" id="execEVal">â€”</div><div class="small">Total kWh</div></div></div></div>
        <div class="chart-panel"><div class="chart-title">Water Sources <span id="execWLbl"></span></div>
          <div class="chart-wrap donut-center"><canvas id="execWDonut"></canvas>
            <div class="donut-label"><div class="big" id="execWVal">â€”</div><div class="small">Total KL</div></div></div></div>
      </div>
      <div class="section-title">Food â€” Planned vs Actual</div>
      <div class="chart-panel wide" style="margin-bottom:24px">
        <div class="chart-title">Food Production All Months <span>kg</span></div>
        <div class="chart-wrap tall"><canvas id="execFoodBar"></canvas></div>
      </div>
      <div class="section-title">Pillar Summary</div>
      <div class="chart-panel">
        <table class="data-table"><thead><tr><th>Pillar</th><th>Latest Value</th><th>Status</th><th>Source</th></tr></thead>
        <tbody id="execSummaryBody"></tbody></table>
      </div>
    </div>

    <!-- ENERGY -->
    <div id="page-energy" class="page">
      <div class="section-title">âš¡ Energy Performance</div>
      <div class="month-filter" id="energyMF"></div>
      <div class="kpi-grid" id="energyKpis"></div>
      <div class="chart-grid">
        <div class="chart-panel"><div class="chart-title">Source Mix <span>kWh</span></div>
          <div class="chart-wrap donut-center"><canvas id="eDonut"></canvas>
            <div class="donut-label"><div class="big" id="eTot">â€”</div><div class="small">kWh</div></div></div></div>
        <div class="chart-panel"><div class="chart-title">Monthly Trend <span>kWh</span></div>
          <div class="chart-wrap"><canvas id="eTrend"></canvas></div></div>
      </div>
      <div class="section-title">Table 1 â€” Monthly Power Summary (All Months)</div>
      <div class="chart-panel"><table class="data-table">
        <thead><tr><th>Month</th><th class="num">Solar</th><th class="num">EB</th><th class="num">DG</th><th class="num">Total kWh</th><th class="num">PF</th><th>Status</th></tr></thead>
        <tbody id="energyTb"></tbody></table></div>

      <div class="section-title">Table 3 â€” Clusterwise Power Consumption (kWh)</div>
      <div class="chart-grid" style="margin-bottom:16px">
        <div class="chart-panel"><div class="chart-title">Cluster Actual Consumption <span id="clusterMonthLbl">Jan-2026</span></div>
          <div class="chart-wrap"><canvas id="clusterBar"></canvas></div></div>
        <div class="chart-panel"><div class="chart-title">Cluster Share <span>%</span></div>
          <div class="chart-wrap donut-center"><canvas id="clusterDonut"></canvas>
            <div class="donut-label"><div class="big" id="clusterTot">â€”</div><div class="small">kWh</div></div></div></div>
      </div>
      <div class="chart-panel" style="margin-bottom:24px"><table class="data-table">
        <thead><tr><th>Month</th><th class="num">RP</th><th class="num">MRP</th><th class="num">GP</th><th class="num">VP</th><th class="num">MDP</th><th class="num">CP</th><th class="num">CHP</th><th class="num">SP</th><th class="num">TP</th></tr></thead>
        <tbody id="clusterTb"></tbody></table></div>

      <div class="section-title">Table 4 â€” Daily Power Consumption (Jan 2026)</div>
      <div class="chart-grid" style="margin-bottom:16px">
        <div class="chart-panel"><div class="chart-title">Daily EB Consumption <span>kWh per day</span></div>
          <div class="chart-wrap tall"><canvas id="dailyEbBar"></canvas></div></div>
        <div class="chart-panel"><div class="chart-title">Daily Solar Generation <span>kWh per day</span></div>
          <div class="chart-wrap tall"><canvas id="dailySolarBar"></canvas></div></div>
      </div>
      <div class="chart-panel" style="margin-bottom:24px"><table class="data-table" id="dailyEnergyTbl">
        <thead><tr><th>Date</th><th class="num">EB (kWh)</th><th class="num">Solar (kWh)</th><th class="num">Combined</th></tr></thead>
        <tbody id="dailyTb"></tbody></table></div>
    </div>

    <!-- WATER -->
    <div id="page-water" class="page">
      <div class="section-title">ğŸ’§ Water Performance</div>
      <div class="month-filter" id="waterMF"></div>
      <div class="kpi-grid" id="waterKpis"></div>
      <div class="chart-grid">
        <div class="chart-panel"><div class="chart-title">Source Breakdown <span>KL</span></div>
          <div class="chart-wrap donut-center"><canvas id="wDonut"></canvas>
            <div class="donut-label"><div class="big" id="wTot">â€”</div><div class="small">KL</div></div></div></div>
        <div class="chart-panel"><div class="chart-title">Monthly Trend <span>KL</span></div>
          <div class="chart-wrap"><canvas id="wTrend"></canvas></div></div>
      </div>
      <div class="section-title">Source Detail</div>
      <div class="chart-panel" id="wSourceDetail" style="margin-bottom:24px"></div>
      <div class="section-title">Table 1 â€” Source Stability (All Months)</div>
      <div class="chart-panel" style="margin-bottom:24px"><table class="data-table">
        <thead><tr><th>Month</th><th class="num">Borewell</th><th class="num">Dug Well 1</th><th class="num">Dug Well 2</th><th class="num">Mission Bhag.</th><th class="num">Total KL</th><th class="num">Stability%</th><th>Status</th></tr></thead>
        <tbody id="waterTb"></tbody></table></div>

      <div class="section-title">Table 2 â€” Consumption Balance Sheet (Planned vs Actual)</div>
      <div class="chart-grid" style="margin-bottom:16px">
        <div class="chart-panel"><div class="chart-title">Consumption by Category <span id="consumMonthLbl">Jan-2026</span></div>
          <div class="chart-wrap"><canvas id="consumBar"></canvas></div></div>
        <div class="chart-panel"><div class="chart-title">Category Split <span>Actual KL</span></div>
          <div class="chart-wrap donut-center"><canvas id="consumDonut"></canvas>
            <div class="donut-label"><div class="big" id="consumTot">â€”</div><div class="small">KL</div></div></div></div>
      </div>
      <div class="chart-panel" style="margin-bottom:24px"><table class="data-table">
        <thead><tr><th>Month</th><th>Category</th><th>Location</th><th class="num">Planned (KL)</th><th class="num">Actual (KL)</th><th class="num">Variance (KL)</th><th class="num">Variance %</th><th>Status</th></tr></thead>
        <tbody id="consumTb"></tbody></table></div>

      <div class="section-title">Table 3 â€” Water Quality Report</div>
      <div class="chart-grid" style="margin-bottom:16px">
        <div class="chart-panel"><div class="chart-title">pH Levels by Water Type <span id="qualMonthLbl">Jan-2026</span></div>
          <div class="chart-wrap"><canvas id="phBar"></canvas></div></div>
        <div class="chart-panel"><div class="chart-title">Quality Status Overview</div>
          <div class="chart-wrap donut-center"><canvas id="qualDonut"></canvas>
            <div class="donut-label"><div class="big" id="qualCompliance">â€”</div><div class="small">Compliant</div></div></div></div>
      </div>
      <div class="chart-panel" style="margin-bottom:24px"><table class="data-table">
        <thead><tr><th>Month</th><th>Water Type</th><th class="num">pH</th><th class="num">TDS (ppm)</th><th class="num">Turbidity (NTU)</th><th class="num">Chlorine (ppm)</th><th>E.Coli</th><th class="num">Compliance%</th><th>Status</th></tr></thead>
        <tbody id="qualityTb"></tbody></table></div>
    </div>

    <!-- FOOD -->
    <div id="page-food" class="page">
      <div class="section-title">ğŸŒ± Food Production</div>
      <div class="month-filter" id="foodMF"></div>
      <div class="kpi-grid" id="foodKpis"></div>
      <div class="chart-grid">
        <div class="chart-panel"><div class="chart-title">Planned vs Actual <span>kg</span></div>
          <div class="chart-wrap"><canvas id="fBar"></canvas></div></div>
        <div class="chart-panel"><div class="chart-title">Achievement <span>%</span></div>
          <div class="chart-wrap donut-center"><canvas id="fGauge"></canvas>
            <div class="donut-label"><div class="big" id="fPct">â€”</div><div class="small">Achieved</div></div></div></div>
      </div>
      <div class="section-title">All Months</div>
      <div class="chart-panel"><table class="data-table">
        <thead><tr><th>Month</th><th class="num">Planned kg</th><th class="num">Actual kg</th><th class="num">Variance</th><th class="num">Achievement%</th><th class="num">Families</th><th>Status</th></tr></thead>
        <tbody id="foodTb"></tbody></table></div>
    </div>

    <!-- EARTH -->
    <div id="page-earth" class="page">
      <div class="section-title">ğŸŒ Earth &amp; Waste</div>
      <div class="kpi-grid" id="earthKpis"></div>
      <div class="chart-grid">
        <div class="chart-panel"><div class="chart-title">Waste by Type <span>kg</span></div>
          <div class="chart-wrap"><canvas id="eaBar"></canvas></div></div>
        <div class="chart-panel"><div class="chart-title">Reuse % Trend</div>
          <div class="chart-wrap"><canvas id="eaTrend"></canvas></div></div>
      </div>
      <div class="section-title">All Records</div>
      <div class="chart-panel"><table class="data-table">
        <thead><tr><th>Month</th><th>Waste Type</th><th class="num">Produced kg</th><th class="num">Reused kg</th><th class="num">Processed kg</th><th class="num">Reuse%</th><th>Status</th></tr></thead>
        <tbody id="earthTb"></tbody></table></div>
    </div>

    <!-- AIR -->
    <div id="page-air" class="page">
      <div class="section-title">ğŸ’¨ Air Quality</div>
      <div class="kpi-grid" id="airKpis"></div>
      <div class="chart-grid">
        <div class="chart-panel"><div class="chart-title">PM2.5 Trend <span>Âµg/mÂ³</span></div>
          <div class="chart-wrap"><canvas id="airPm"></canvas></div></div>
        <div class="chart-panel"><div class="chart-title">AQI Trend <span>0â€“500</span></div>
          <div class="chart-wrap"><canvas id="airAqi"></canvas></div></div>
      </div>
      <div class="section-title">All Months</div>
      <div class="chart-panel"><table class="data-table">
        <thead><tr><th>Month</th><th>Location</th><th class="num">PM2.5</th><th class="num">AQI</th><th>Status</th></tr></thead>
        <tbody id="airTb"></tbody></table></div>
    </div>

    <!-- PEOPLE -->
    <div id="page-people" class="page">
      <div class="section-title">ğŸ‘¥ People &amp; Occupancy</div>
      <div class="month-filter" id="peopleMF"></div>
      <div class="kpi-grid" id="peopleKpis"></div>
      <div class="chart-grid">
        <div class="chart-panel"><div class="chart-title">Occupancy <span>villas</span></div>
          <div class="chart-wrap donut-center"><canvas id="pDonut"></canvas>
            <div class="donut-label"><div class="big" id="pPct">â€”</div><div class="small">Occupied</div></div></div></div>
        <div class="chart-panel"><div class="chart-title">Occupancy % Trend</div>
          <div class="chart-wrap"><canvas id="pTrend"></canvas></div></div>
      </div>
      <div class="section-title">All Months</div>
      <div class="chart-panel"><table class="data-table">
        <thead><tr><th>Month</th><th class="num">Total</th><th class="num">Occupied</th><th class="num">Occ%</th><th class="num">Planned FT</th><th class="num">Actual FT</th><th>Status</th></tr></thead>
        <tbody id="peopleTb"></tbody></table></div>
    </div>

    <!-- SHELTER -->
    <div id="page-shelter" class="page">
      <div class="section-title">ğŸ  Shelter &amp; Maintenance</div>
      <div class="month-filter" id="shelterMF"></div>
      <div class="kpi-grid" id="shelterKpis"></div>
      <div class="chart-grid">
        <div class="chart-panel"><div class="chart-title">Category Progress <span>%</span></div>
          <div class="chart-wrap"><canvas id="shCat"></canvas></div></div>
        <div class="chart-panel"><div class="chart-title">Completion % Trend</div>
          <div class="chart-wrap"><canvas id="shTrend"></canvas></div></div>
      </div>
      <div class="section-title">All Months</div>
      <div class="chart-panel"><table class="data-table">
        <thead><tr><th>Month</th><th class="num">Planned</th><th class="num">Done</th><th class="num">Done%</th><th class="num">Civil%</th><th class="num">Landscape%</th><th class="num">Pest%</th><th>Status</th></tr></thead>
        <tbody id="shelterTb"></tbody></table></div>
    </div>

  </main>
  <footer class="footer">SAPTAPATHA SUSTAINABILITY TRACKER Â· 7 PILLARS Â· 182 VILLAS Â· Drop a new Excel file or use âœï¸ Enter Data any time</footer>
</div>


<!-- â•â•â•â•â•â• GITHUB SYNC MODAL â•â•â•â•â•â• -->
<div class="gh-modal" id="ghModal">
  <div class="gh-box">
    <div class="gh-title">â˜ï¸ GitHub Sync</div>
    <div class="gh-sub">Store your data as <code style="color:var(--blue);font-size:10px">data.json</code> in your GitHub repo. Every push creates a versioned commit â€” your full data history is preserved.</div>

    <div class="gh-field">
      <label>GitHub Username</label>
      <input type="text" id="gh_owner" placeholder="e.g. soumik-organo" oninput="ghSaveConfig()">
    </div>
    <div class="gh-field">
      <label>Repository Name</label>
      <input type="text" id="gh_repo" placeholder="e.g. saptapatha-dashboard" oninput="ghSaveConfig()">
    </div>
    <div class="gh-field">
      <label>Personal Access Token &nbsp;<span style="color:var(--blue);font-size:9px">(saved only in this browser)</span></label>
      <input type="password" id="gh_token" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" oninput="ghSaveConfig()">
    </div>

    <div class="gh-hint">
      ğŸ”‘ <strong>How to create a token:</strong><br>
      GitHub â†’ <a href="https://github.com/settings/personal-access-tokens/new" target="_blank">Settings â†’ Developer settings â†’ Fine-grained tokens â†’ Generate new token</a><br>
      â†’ Under "Repository access" select only <strong>saptapatha-dashboard</strong><br>
      â†’ Under "Permissions â†’ Contents" choose <strong>Read and write</strong> â†’ Generate
    </div>

    <div id="ghStatus" class="gh-status"></div>

    <div class="gh-actions">
      <button class="gh-btn gh-btn-cancel" onclick="closeGHModal()">Cancel</button>
      <button class="gh-btn gh-btn-primary" onclick="ghPull()" style="background:var(--bg3);color:var(--blue);border:1px solid rgba(77,184,255,0.3);">â¬‡ Pull</button>
      <button class="gh-btn gh-btn-primary" onclick="ghPush()">â¬† Push to GitHub</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â• CLEAR DATA MODAL â•â•â•â•â•â• -->
<div id="clearModal">
  <div class="clear-modal-box">
    <div class="clear-modal-title">ğŸ—‘ï¸ Clear Data</div>
    <div class="clear-modal-sub">Choose what to remove. This cannot be undone.</div>
    <div class="clear-checkboxes">
      <label class="clear-check"><input type="checkbox" id="clr-excel" checked=""> ğŸ“Š Excel data (loaded file)</label>
      <label class="clear-check"><input type="checkbox" id="clr-manual" checked=""> âœï¸ Manually entered data</label>
    </div>
    <div class="clear-modal-actions">
      <button class="clear-cancel-btn" onclick="closeClearModal()">Cancel</button>
      <button class="clear-confirm-btn" onclick="confirmClearData()">Clear Selected</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â• ENTRY DRAWER â•â•â•â•â•â• -->
<div id="entry-overlay" onclick="closeDrawer()"></div>
<div id="entry-drawer">

  <div class="drawer-header">
    <div class="drawer-title-row">
      <div class="drawer-title">âœï¸ <span>Enter Data</span></div>
      <button class="drawer-close" onclick="closeDrawer()">âœ•</button>
    </div>
    <div class="drawer-month-row">
      <label>MONTH</label>
      <input class="month-input" id="entryMonth" placeholder="e.g. Feb-2026" list="existingMonths">
      <datalist id="existingMonths"></datalist>
      <select class="month-select-existing" id="monthSelect" onchange="loadMonthIntoForm(this.value)" title="Load existing month">
        <option value="">Load existingâ€¦</option>
      </select>
    </div>
    <!-- Pillar tabs -->
    <div class="drawer-pillar-tabs" id="drawerPillarTabs">
      <button class="dp-tab active" onclick="switchDrawerTab(&#39;energy&#39;,this)">âš¡ Energy</button>
      <button class="dp-tab" onclick="switchDrawerTab(&#39;water&#39;,this)">ğŸ’§ Water</button>
      <button class="dp-tab" onclick="switchDrawerTab(&#39;food&#39;,this)">ğŸŒ± Food</button>
      <button class="dp-tab" onclick="switchDrawerTab(&#39;earth&#39;,this)">ğŸŒ Earth</button>
      <button class="dp-tab" onclick="switchDrawerTab(&#39;air&#39;,this)">ğŸ’¨ Air</button>
      <button class="dp-tab" onclick="switchDrawerTab(&#39;people&#39;,this)">ğŸ‘¥ People</button>
      <button class="dp-tab" onclick="switchDrawerTab(&#39;shelter&#39;,this)">ğŸ  Shelter</button>
    </div>
  </div>

  <div class="drawer-body">

    <!-- ENERGY PANEL -->
    <div class="dp-panel active" id="dpEnergy">

      <div class="field-group">
        <div class="field-group-title">âš¡ Monthly Power Summary</div>
        <div class="field-row triple">
          <div class="field"><label>Solar (kWh)</label><input type="number" id="f_solar" placeholder="0" oninput="updateEnergyCalc()"></div>
          <div class="field"><label>EB (kWh)</label><input type="number" id="f_eb" placeholder="0" oninput="updateEnergyCalc()"></div>
          <div class="field"><label>DG (kWh)</label><input type="number" id="f_dg" placeholder="0" oninput="updateEnergyCalc()"></div>
        </div>
        <div class="field-row">
          <div class="field"><label>Villas kWh</label><input type="number" id="f_e_villas" placeholder="0"></div>
          <div class="field"><label>Common Areas kWh</label><input type="number" id="f_e_common" placeholder="0"></div>
        </div>
        <div class="field-row">
          <div class="field"><label>Power Factor</label><input type="number" id="f_pf" placeholder="0.98" step="0.01" min="0" max="1"></div>
          <div class="field"><label>Status</label>
            <select id="f_e_status"><option value="">Auto</option><option value="Green">ğŸŸ¢ Green</option><option value="Amber">ğŸŸ¡ Amber</option><option value="Red">ğŸ”´ Red</option></select>
          </div>
        </div>
        <div class="computed-row" id="energyCalc"></div>
      </div>

      <div class="field-group">
        <div class="field-group-title">ğŸ˜ï¸ Clusterwise Consumption (kWh)</div>
        <div class="field-row triple">
          <div class="field"><label>RP</label><input type="number" id="f_cl_RP" placeholder="0" oninput="updateClusterCalc()"></div>
          <div class="field"><label>MRP</label><input type="number" id="f_cl_MRP" placeholder="0" oninput="updateClusterCalc()"></div>
          <div class="field"><label>GP</label><input type="number" id="f_cl_GP" placeholder="0" oninput="updateClusterCalc()"></div>
        </div>
        <div class="field-row triple">
          <div class="field"><label>VP</label><input type="number" id="f_cl_VP" placeholder="0" oninput="updateClusterCalc()"></div>
          <div class="field"><label>MDP</label><input type="number" id="f_cl_MDP" placeholder="0" oninput="updateClusterCalc()"></div>
          <div class="field"><label>CP</label><input type="number" id="f_cl_CP" placeholder="0" oninput="updateClusterCalc()"></div>
        </div>
        <div class="field-row triple">
          <div class="field"><label>CHP</label><input type="number" id="f_cl_CHP" placeholder="0" oninput="updateClusterCalc()"></div>
          <div class="field"><label>SP</label><input type="number" id="f_cl_SP" placeholder="0" oninput="updateClusterCalc()"></div>
          <div class="field"><label>TP</label><input type="number" id="f_cl_TP" placeholder="0" oninput="updateClusterCalc()"></div>
        </div>
        <div class="computed-row" id="clusterCalc"></div>
      </div>

      <div class="field-group">
        <div class="field-group-title">ğŸ“… Daily Power Consumption (kWh per day)</div>
        <div style="display:grid;grid-template-columns:32px 1fr 1fr;gap:4px 8px;margin-bottom:10px;align-items:center;">
          <div style="font-size:9px;color:var(--text3);font-family:var(--mono);text-align:center">DAY</div>
          <div style="font-size:9px;color:var(--blue);font-family:var(--mono);text-align:center">EB kWh</div>
          <div style="font-size:9px;color:var(--amber);font-family:var(--mono);text-align:center">SOLAR kWh</div>
          <div id="dailyInputGrid" style="display:contents"></div>
        </div>
        <div class="computed-row" id="dailyCalc"></div>
      </div>

    </div>

    <!-- WATER PANEL -->
    <div class="dp-panel" id="dpWater">
      <div class="field-group">
        <div class="field-group-title">ğŸ’§ Water Sources (KL)</div>
        <div class="field-row">
          <div class="field"><label>Dug Well 1</label><input type="number" id="f_dw1" placeholder="0" oninput="updateWaterCalc()"></div>
          <div class="field"><label>Borewell</label><input type="number" id="f_borewell" placeholder="0" oninput="updateWaterCalc()"></div>
        </div>
        <div class="field-row">
          <div class="field"><label>Dug Well 2</label><input type="number" id="f_dw2" placeholder="0" oninput="updateWaterCalc()"></div>
          <div class="field"><label>Mission Bhagirath</label><input type="number" id="f_mb" placeholder="0" oninput="updateWaterCalc()"></div>
        </div>
        <div class="field-row">
          <div class="field"><label>Days Unavailable</label><input type="number" id="f_days_unavail" placeholder="0" oninput="updateWaterCalc()"></div>
          <div class="field"><label>Status</label>
            <select id="f_w_status"><option value="">Auto</option><option value="Green">ğŸŸ¢ Green</option><option value="Amber">ğŸŸ¡ Amber</option><option value="Red">ğŸ”´ Red</option></select>
          </div>
        </div>
        <div class="computed-row" id="waterCalc"></div>
      </div>

      <div class="field-group">
        <div class="field-group-title">ğŸ“Š Consumption Balance Sheet (KL)</div>
        <table class="dt">
          <thead><tr><th>Category</th><th style="color:var(--blue)">Planned</th><th style="color:var(--accent)">Actual</th><th>Variance</th></tr></thead>
          <tbody>
            <tr><td>Per Villa â€” Domestic</td><td><input type="number" class="mini-num" id="f_wc_villa_p" placeholder="0" oninput="updateWaterConsumCalc()"></td><td><input type="number" class="mini-num" id="f_wc_villa_a" placeholder="0" oninput="updateWaterConsumCalc()"></td><td class="var-cell" id="wc_villa_v">â€”</td></tr>
            <tr><td>Per Villa â€” Irrigation</td><td><input type="number" class="mini-num" id="f_wc_irrig_p" placeholder="0" oninput="updateWaterConsumCalc()"></td><td><input type="number" class="mini-num" id="f_wc_irrig_a" placeholder="0" oninput="updateWaterConsumCalc()"></td><td class="var-cell" id="wc_irrig_v">â€”</td></tr>
            <tr><td>Rurban Hive</td><td><input type="number" class="mini-num" id="f_wc_rhive_p" placeholder="0" oninput="updateWaterConsumCalc()"></td><td><input type="number" class="mini-num" id="f_wc_rhive_a" placeholder="0" oninput="updateWaterConsumCalc()"></td><td class="var-cell" id="wc_rhive_v">â€”</td></tr>
            <tr><td>GOO</td><td><input type="number" class="mini-num" id="f_wc_goo_p" placeholder="0" oninput="updateWaterConsumCalc()"></td><td><input type="number" class="mini-num" id="f_wc_goo_a" placeholder="0" oninput="updateWaterConsumCalc()"></td><td class="var-cell" id="wc_goo_v">â€”</td></tr>
            <tr><td>Swimming Pool</td><td><input type="number" class="mini-num" id="f_wc_pool_p" placeholder="0" oninput="updateWaterConsumCalc()"></td><td><input type="number" class="mini-num" id="f_wc_pool_a" placeholder="0" oninput="updateWaterConsumCalc()"></td><td class="var-cell" id="wc_pool_v">â€”</td></tr>
            <tr><td>Landscaping &amp; Farming</td><td><input type="number" class="mini-num" id="f_wc_land_p" placeholder="0" oninput="updateWaterConsumCalc()"></td><td><input type="number" class="mini-num" id="f_wc_land_a" placeholder="0" oninput="updateWaterConsumCalc()"></td><td class="var-cell" id="wc_land_v">â€”</td></tr>
          </tbody>
        </table>
        <div class="computed-row" id="waterConsumCalc"></div>
      </div>

      <div class="field-group">
        <div class="field-group-title">ğŸ§ª Water Quality Report</div>
        <table class="dt">
          <thead><tr><th>Location</th><th>pH</th><th>TDS (ppm)</th><th>Turb. (NTU)</th><th>Cl (ppm)</th><th>E.Coli</th><th>Status</th></tr></thead>
          <tbody>
            <tr><td>Swimming Pool</td><td><input type="number" class="mini-num" id="f_wq_pool_ph" placeholder="7.0" step="0.1"></td><td><input type="number" class="mini-num" id="f_wq_pool_tds" placeholder="0"></td><td><input type="number" class="mini-num" id="f_wq_pool_turb" placeholder="0"></td><td><input type="number" class="mini-num" id="f_wq_pool_cl" placeholder="0" step="0.1"></td><td><input type="text" class="mini-txt" id="f_wq_pool_ecoli" placeholder="ND"></td><td><select class="mini-sel" id="f_wq_pool_st"><option value="">â€”</option><option value="Green">ğŸŸ¢</option><option value="Amber">ğŸŸ¡</option><option value="Red">ğŸ”´</option></select></td></tr>
            <tr><td>WTP</td><td><input type="number" class="mini-num" id="f_wq_wtp_ph" placeholder="7.0" step="0.1"></td><td><input type="number" class="mini-num" id="f_wq_wtp_tds" placeholder="0"></td><td><input type="number" class="mini-num" id="f_wq_wtp_turb" placeholder="0"></td><td><input type="number" class="mini-num" id="f_wq_wtp_cl" placeholder="0" step="0.1"></td><td><input type="text" class="mini-txt" id="f_wq_wtp_ecoli" placeholder="ND"></td><td><select class="mini-sel" id="f_wq_wtp_st"><option value="">â€”</option><option value="Green">ğŸŸ¢</option><option value="Amber">ğŸŸ¡</option><option value="Red">ğŸ”´</option></select></td></tr>
            <tr><td>Dug Well 1</td><td><input type="number" class="mini-num" id="f_wq_dw1_ph" placeholder="7.0" step="0.1"></td><td><input type="number" class="mini-num" id="f_wq_dw1_tds" placeholder="0"></td><td><input type="number" class="mini-num" id="f_wq_dw1_turb" placeholder="0"></td><td><input type="number" class="mini-num" id="f_wq_dw1_cl" placeholder="0" step="0.1"></td><td><input type="text" class="mini-txt" id="f_wq_dw1_ecoli" placeholder="ND"></td><td><select class="mini-sel" id="f_wq_dw1_st"><option value="">â€”</option><option value="Green">ğŸŸ¢</option><option value="Amber">ğŸŸ¡</option><option value="Red">ğŸ”´</option></select></td></tr>
            <tr><td>Dug Well 2</td><td><input type="number" class="mini-num" id="f_wq_dw2_ph" placeholder="7.0" step="0.1"></td><td><input type="number" class="mini-num" id="f_wq_dw2_tds" placeholder="0"></td><td><input type="number" class="mini-num" id="f_wq_dw2_turb" placeholder="0"></td><td><input type="number" class="mini-num" id="f_wq_dw2_cl" placeholder="0" step="0.1"></td><td><input type="text" class="mini-txt" id="f_wq_dw2_ecoli" placeholder="ND"></td><td><select class="mini-sel" id="f_wq_dw2_st"><option value="">â€”</option><option value="Green">ğŸŸ¢</option><option value="Amber">ğŸŸ¡</option><option value="Red">ğŸ”´</option></select></td></tr>
            <tr><td>Tertiary Plant</td><td><input type="number" class="mini-num" id="f_wq_tert_ph" placeholder="7.0" step="0.1"></td><td><input type="number" class="mini-num" id="f_wq_tert_tds" placeholder="0"></td><td><input type="number" class="mini-num" id="f_wq_tert_turb" placeholder="0"></td><td><input type="number" class="mini-num" id="f_wq_tert_cl" placeholder="0" step="0.1"></td><td><input type="text" class="mini-txt" id="f_wq_tert_ecoli" placeholder="ND"></td><td><select class="mini-sel" id="f_wq_tert_st"><option value="">â€”</option><option value="Green">ğŸŸ¢</option><option value="Amber">ğŸŸ¡</option><option value="Red">ğŸ”´</option></select></td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- FOOD PANEL -->
    <div class="dp-panel" id="dpFood">
      <div class="field-group">
        <div class="field-group-title">ğŸŒ± Monthly Crop Production (30 crops)</div>
        <table class="dt">
          <thead><tr><th style="min-width:80px">Crop Name</th><th style="min-width:90px">Type</th><th style="color:var(--blue)">Planned (kg)</th><th style="color:var(--accent)">Actual (kg)</th><th>Variance</th></tr></thead>
          <tbody id="foodCropGrid"></tbody>
        </table>
        <div class="computed-row" id="foodCalc"></div>
      </div>
      <div class="field-group">
        <div class="field-group-title">Summary</div>
        <div class="field-row">
          <div class="field"><label>Families Served</label><input type="number" id="f_families" placeholder="0"></div>
          <div class="field"><label>Status</label>
            <select id="f_f_status"><option value="">Auto</option><option value="Green">ğŸŸ¢ Green</option><option value="Amber">ğŸŸ¡ Amber</option><option value="Red">ğŸ”´ Red</option></select>
          </div>
        </div>
      </div>
    </div>

    <!-- EARTH PANEL -->
    <div class="dp-panel" id="dpEarth">
      <div class="field-group">
        <div class="field-group-title">ğŸŒ Waste Management (kg)</div>
        <table class="dt">
          <thead><tr><th>Waste Type</th><th style="color:var(--text2)">Produced</th><th style="color:var(--accent)">Reused</th><th style="color:var(--blue)">Processed</th><th style="color:var(--amber)">Residue</th></tr></thead>
          <tbody>
            <tr><td>ğŸƒ Organic</td><td><input type="number" class="mini-num" id="f_ea_organic_prod" placeholder="0" oninput="updateEarthCalc()"></td><td><input type="number" class="mini-num" id="f_ea_organic_reused" placeholder="0" oninput="updateEarthCalc()"></td><td><input type="number" class="mini-num" id="f_ea_organic_proc" placeholder="0" oninput="updateEarthCalc()"></td><td class="residue-cell" id="ea_organic_res">â€”</td></tr>
            <tr><td>ğŸ§´ Plastic</td><td><input type="number" class="mini-num" id="f_ea_plastic_prod" placeholder="0" oninput="updateEarthCalc()"></td><td><input type="number" class="mini-num" id="f_ea_plastic_reused" placeholder="0" oninput="updateEarthCalc()"></td><td><input type="number" class="mini-num" id="f_ea_plastic_proc" placeholder="0" oninput="updateEarthCalc()"></td><td class="residue-cell" id="ea_plastic_res">â€”</td></tr>
            <tr><td>ğŸ’» E-Waste</td><td><input type="number" class="mini-num" id="f_ea_ewaste_prod" placeholder="0" oninput="updateEarthCalc()"></td><td><input type="number" class="mini-num" id="f_ea_ewaste_reused" placeholder="0" oninput="updateEarthCalc()"></td><td><input type="number" class="mini-num" id="f_ea_ewaste_proc" placeholder="0" oninput="updateEarthCalc()"></td><td class="residue-cell" id="ea_ewaste_res">â€”</td></tr>
            <tr><td>ğŸ§± Construction</td><td><input type="number" class="mini-num" id="f_ea_const_prod" placeholder="0" oninput="updateEarthCalc()"></td><td><input type="number" class="mini-num" id="f_ea_const_reused" placeholder="0" oninput="updateEarthCalc()"></td><td><input type="number" class="mini-num" id="f_ea_const_proc" placeholder="0" oninput="updateEarthCalc()"></td><td class="residue-cell" id="ea_const_res">â€”</td></tr>
            <tr><td>ğŸ“„ Paper</td><td><input type="number" class="mini-num" id="f_ea_paper_prod" placeholder="0" oninput="updateEarthCalc()"></td><td><input type="number" class="mini-num" id="f_ea_paper_reused" placeholder="0" oninput="updateEarthCalc()"></td><td><input type="number" class="mini-num" id="f_ea_paper_proc" placeholder="0" oninput="updateEarthCalc()"></td><td class="residue-cell" id="ea_paper_res">â€”</td></tr>
            <tr><td>ğŸ«™ Glass</td><td><input type="number" class="mini-num" id="f_ea_glass_prod" placeholder="0" oninput="updateEarthCalc()"></td><td><input type="number" class="mini-num" id="f_ea_glass_reused" placeholder="0" oninput="updateEarthCalc()"></td><td><input type="number" class="mini-num" id="f_ea_glass_proc" placeholder="0" oninput="updateEarthCalc()"></td><td class="residue-cell" id="ea_glass_res">â€”</td></tr>
          </tbody>
        </table>
        <div class="computed-row" id="earthCalc"></div>
      </div>

      <div class="field-group">
        <div class="field-group-title">ğŸ¦‹ Biodiversity Indicators</div>
        <table class="dt">
          <thead><tr><th>Indicator Type</th><th style="color:var(--accent);text-align:center">Count</th></tr></thead>
          <tbody id="bioGrid"></tbody>
        </table>
      </div>

      <div class="field-group">
        <div class="field-group-title">Cover &amp; Status</div>
        <div class="field-row">
          <div class="field"><label>Green Cover %</label><input type="number" id="f_greencover" placeholder="0" min="0" max="100"></div>
          <div class="field"><label>Status</label>
            <select id="f_ea_status"><option value="">Auto</option><option value="Green">ğŸŸ¢ Green</option><option value="Amber">ğŸŸ¡ Amber</option><option value="Red">ğŸ”´ Red</option></select>
          </div>
        </div>
      </div>
    </div>

    <!-- AIR PANEL -->
    <div class="dp-panel" id="dpAir">
      <div class="field-group">
        <div class="field-group-title">ğŸ’¨ Outdoor Air Quality Readings</div>
        <div class="field-row single">
          <div class="field"><label>Location Measured</label>
            <select id="f_location">
              <option value="">Select locationâ€¦</option>
              <option>Rurban Hive</option><option>GOO</option><option>Main Gate</option>
              <option>Club House</option><option>Lake Front</option><option>Farm Zone</option>
              <option>Playground</option><option>Community Hall</option><option>Temple Area</option>
              <option>Villa Zone A</option><option>Villa Zone B</option><option>Villa Zone C</option>
              <option>Orchard</option>
            </select>
          </div>
        </div>
        <div class="field-group-title" style="margin-top:14px">PM2.5 (Âµg/mÂ³) â€” 4 Weekly Readings</div>
        <div class="field-row">
          <div class="field"><label>Week 1</label><input type="number" id="f_pm_w1" placeholder="0" oninput="updateAirCalc()"></div>
          <div class="field"><label>Week 2</label><input type="number" id="f_pm_w2" placeholder="0" oninput="updateAirCalc()"></div>
        </div>
        <div class="field-row">
          <div class="field"><label>Week 3</label><input type="number" id="f_pm_w3" placeholder="0" oninput="updateAirCalc()"></div>
          <div class="field"><label>Week 4</label><input type="number" id="f_pm_w4" placeholder="0" oninput="updateAirCalc()"></div>
        </div>
        <div class="field-group-title" style="margin-top:14px">AQI â€” 4 Weekly Readings</div>
        <div class="field-row">
          <div class="field"><label>AQI Week 1</label><input type="number" id="f_aqi_w1" placeholder="0" oninput="updateAirCalc()"></div>
          <div class="field"><label>AQI Week 2</label><input type="number" id="f_aqi_w2" placeholder="0" oninput="updateAirCalc()"></div>
        </div>
        <div class="field-row">
          <div class="field"><label>AQI Week 3</label><input type="number" id="f_aqi_w3" placeholder="0" oninput="updateAirCalc()"></div>
          <div class="field"><label>AQI Week 4</label><input type="number" id="f_aqi_w4" placeholder="0" oninput="updateAirCalc()"></div>
        </div>
        <div class="field-group-title" style="margin-top:14px">Additional Readings</div>
        <div class="field-row triple">
          <div class="field"><label>Avg PM10</label><input type="number" id="f_pm10" placeholder="0"></div>
          <div class="field"><label>Avg CO2 (ppm)</label><input type="number" id="f_co2" placeholder="0"></div>
          <div class="field"><label>Status</label>
            <select id="f_air_status"><option value="">Auto</option><option value="Green">ğŸŸ¢ Green</option><option value="Amber">ğŸŸ¡ Amber</option><option value="Red">ğŸ”´ Red</option></select>
          </div>
        </div>
        <div class="computed-row" id="airCalc"></div>
      </div>
    </div>

    <!-- PEOPLE PANEL -->
    <div class="dp-panel" id="dpPeople">
      <div class="field-group">
        <div class="field-group-title">ğŸ‘¥ Villa Occupancy</div>
        <div class="field-row">
          <div class="field"><label>Total Villas</label><input type="number" id="f_total_villas" placeholder="182" value="182"></div>
          <div class="field"><label>Occupied Villas</label><input type="number" id="f_occupied" placeholder="0" oninput="updatePeopleCalc()"></div>
        </div>
      </div>
      <div class="field-group">
        <div class="field-group-title">Footfall &amp; Events</div>
        <div class="field-row">
          <div class="field"><label>Planned Footfall</label><input type="number" id="f_plan_ft" placeholder="0"></div>
          <div class="field"><label>Actual Footfall</label><input type="number" id="f_act_ft" placeholder="0"></div>
        </div>
        <div class="field-row">
          <div class="field"><label>Events This Month</label><input type="number" id="f_events" placeholder="0"></div>
          <div class="field"><label>Status</label>
            <select id="f_p_status"><option value="">Auto</option><option value="Green">ğŸŸ¢ Green</option><option value="Amber">ğŸŸ¡ Amber</option><option value="Red">ğŸ”´ Red</option></select>
          </div>
        </div>
        <div class="computed-row" id="peopleCalc"></div>
      </div>
    </div>

    <!-- SHELTER PANEL -->
    <div class="dp-panel" id="dpShelter">
      <div class="field-group">
        <div class="field-group-title">ğŸ  Maintenance Tasks</div>
        <div class="field-row">
          <div class="field"><label>Planned Tasks</label><input type="number" id="f_planned_tasks" placeholder="0" oninput="updateShelterCalc()"></div>
          <div class="field"><label>Completed Tasks</label><input type="number" id="f_done_tasks" placeholder="0" oninput="updateShelterCalc()"></div>
        </div>
      </div>
      <div class="field-group">
        <div class="field-group-title">Category Completion (%)</div>
        <div class="field-row triple">
          <div class="field"><label>Civil Infra</label><input type="number" id="f_civil" placeholder="0" min="0" max="100"></div>
          <div class="field"><label>Landscaping</label><input type="number" id="f_landscape" placeholder="0" min="0" max="100"></div>
          <div class="field"><label>Pest Mgmt</label><input type="number" id="f_pest" placeholder="0" min="0" max="100"></div>
        </div>
        <div class="field-row single">
          <div class="field"><label>Status</label>
            <select id="f_sh_status"><option value="">Auto</option><option value="Green">ğŸŸ¢ Green</option><option value="Amber">ğŸŸ¡ Amber</option><option value="Red">ğŸ”´ Red</option></select>
          </div>
        </div>
        <div class="computed-row" id="shelterCalc"></div>
      </div>
    </div>

    <!-- Saved entries -->
    <div style="margin-top:28px;padding-top:20px;border-top:1px solid var(--border)">
      <div class="field-group-title" style="margin-bottom:12px">SAVED ENTRIES</div>
      <div id="savedEntriesList"><div style="font-size:11px;color:var(--text3);font-family:var(--mono)">No entries yet.</div></div>
    </div>

  </div>

  <div class="drawer-footer">
    <button class="save-btn" onclick="saveEntry()">ğŸ’¾ Save Month Data</button>
    <button class="clear-btn" onclick="clearForm()" title="Clear all fields">âœ• Clear</button>
    <span class="save-feedback" id="saveFeedback">âœ“ Saved!</span>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONSTANTS & STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const C={green:'#2dff8a',amber:'#ffb340',red:'#ff5252',blue:'#4db8ff',purple:'#b07dff',yellow:'#f7c948',orange:'#ff9c5b',grey:'#2a4a3a'};
Chart.defaults.color='#6a9a80';
Chart.defaults.font.family="'DM Mono',monospace";
Chart.defaults.font.size=11;
const charts={};
let selMonth={};

// D holds merged data from ALL sources (manual entries + Excel)
let D={energy:[],water:[],food:[],earth:[],air:[],people:[],shelter:[],energyCluster:[],energyDaily:[],waterConsumption:[],waterQuality:[]};

// manualEntries: array of {month, energy:{}, water:{}, food:{}, earth:[], air:{}, people:{}, shelter:{}}
let manualEntries=[];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PERSISTENCE (window.storage)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function saveToStorage() {
  try { await window.storage.set('saptapatha-entries', JSON.stringify(manualEntries)); } catch(e){}
}
async function loadFromStorage() {
  try {
    const r = await window.storage.get('saptapatha-entries');
    if (r && r.value) { manualEntries = JSON.parse(r.value) || []; }
  } catch(e){}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT / IMPORT JSON
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportJSON(){
  const payload={
    version:1,
    exportedAt:new Date().toISOString(),
    manualEntries
  };
  const blob=new Blob([JSON.stringify(payload,null,2)],{type:'application/json'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download=`saptapatha-data-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
  toast('â¬‡ï¸ Data exported as JSON');
}

function importJSON(input){
  const file=input.files[0]; if(!file)return;
  const reader=new FileReader();
  reader.onload=async e=>{
    try{
      const parsed=JSON.parse(e.target.result);
      const entries=parsed.manualEntries||parsed; // support both wrapped and raw array
      if(!Array.isArray(entries)) throw new Error('Invalid format');
      // Merge: imported entries take priority for their months
      const importMonths=new Set(entries.map(e=>e.month));
      manualEntries=[...manualEntries.filter(e=>!importMonths.has(e.month)),...entries];
      manualEntries.sort((a,b)=>a.month.localeCompare(b.month));
      await saveToStorage();
      rebuildDFromManual();
      mergeAndRender(document.getElementById('fileBadge').textContent||'Manual Data');
      renderSavedEntriesList();
      refreshMonthSelects();
      toast(`âœ… Imported ${entries.length} entries`);
    }catch(err){
      toast('âŒ Import failed: '+err.message,true);
    }
    input.value='';
  };
  reader.readAsText(file);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GITHUB SYNC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GH_FILE = 'data.json';

function ghLoadConfig(){
  try{
    const cfg=JSON.parse(localStorage.getItem('gh_config')||'{}');
    if(cfg.owner) document.getElementById('gh_owner').value=cfg.owner;
    if(cfg.repo)  document.getElementById('gh_repo').value=cfg.repo;
    if(cfg.token) document.getElementById('gh_token').value=cfg.token;
  }catch(e){}
}
function ghSaveConfig(){
  const cfg={
    owner:document.getElementById('gh_owner').value.trim(),
    repo: document.getElementById('gh_repo').value.trim(),
    token:document.getElementById('gh_token').value.trim()
  };
  try{ localStorage.setItem('gh_config',JSON.stringify(cfg)); }catch(e){}
}
function ghGetConfig(){
  return{
    owner:document.getElementById('gh_owner').value.trim(),
    repo: document.getElementById('gh_repo').value.trim(),
    token:document.getElementById('gh_token').value.trim()
  };
}

function openGHModal(){
  ghLoadConfig();
  document.getElementById('ghModal').classList.add('show');
  ghSetStatus('','');
}
function closeGHModal(){
  document.getElementById('ghModal').classList.remove('show');
}

function ghSetStatus(msg,type){
  const el=document.getElementById('ghStatus');
  el.textContent=msg;
  el.className='gh-status'+(msg?' show':'')+' '+(type||'');
}

async function ghPush(){
  const {owner,repo,token}=ghGetConfig();
  if(!owner||!repo||!token){ghSetStatus('âš ï¸ Fill in all three fields first','err');return;}

  ghSetStatus('â¬† Pushing to GitHubâ€¦','loading');

  const payload=JSON.stringify({
    version:1,
    pushedAt:new Date().toISOString(),
    manualEntries
  },null,2);
  const content=btoa(unescape(encodeURIComponent(payload))); // base64 UTF-8 safe

  const apiUrl=`https://api.github.com/repos/${owner}/${repo}/contents/${GH_FILE}`;
  const headers={'Authorization':'Bearer '+token,'Content-Type':'application/json','Accept':'application/vnd.github+json'};

  try{
    // Try to get current SHA (needed to update existing file)
    let sha=null;
    const getRes=await fetch(apiUrl,{headers});
    if(getRes.ok){
      const existing=await getRes.json();
      sha=existing.sha;
    } else if(getRes.status!==404){
      throw new Error(`GitHub API error ${getRes.status}: ${(await getRes.json()).message||''}`);
    }

    const body={
      message:`saptapatha: data update ${new Date().toISOString().slice(0,16).replace('T',' ')}`,
      content,
      ...(sha?{sha}:{})
    };

    const putRes=await fetch(apiUrl,{method:'PUT',headers,body:JSON.stringify(body)});
    const putData=await putRes.json();
    if(!putRes.ok) throw new Error(putData.message||`HTTP ${putRes.status}`);

    ghSetStatus(`âœ… Pushed successfully! Commit: ${putData.commit?.sha?.slice(0,7)}  Â·  ${new Date().toLocaleTimeString()}`,'ok');
    document.getElementById('ghBtn').classList.add('synced');
    document.getElementById('ghBtn').textContent='âœ… GitHub';
    setTimeout(()=>{
      document.getElementById('ghBtn').classList.remove('synced');
      document.getElementById('ghBtn').textContent='â˜ï¸ GitHub';
    },4000);
    toast('â˜ï¸ Saved to GitHub!');
  }catch(err){
    ghSetStatus('âŒ Push failed: '+err.message,'err');
    toast('âŒ GitHub push failed',true);
  }
}

async function ghPull(){
  const {owner,repo,token}=ghGetConfig();
  if(!owner||!repo||!token){ghSetStatus('âš ï¸ Fill in all three fields first','err');return;}

  ghSetStatus('â¬‡ Pulling from GitHubâ€¦','loading');

  const apiUrl=`https://api.github.com/repos/${owner}/${repo}/contents/${GH_FILE}`;
  const headers={'Authorization':'Bearer '+token,'Accept':'application/vnd.github+json'};

  try{
    const res=await fetch(apiUrl,{headers});
    if(res.status===404){ghSetStatus('âš ï¸ No data.json found â€” push first to create it','err');return;}
    if(!res.ok) throw new Error(`HTTP ${res.status}: ${(await res.json()).message||''}`);

    const data=await res.json();
    const decoded=decodeURIComponent(escape(atob(data.content.replace(/\n/g,''))));
    const parsed=JSON.parse(decoded);
    const entries=parsed.manualEntries||parsed;
    if(!Array.isArray(entries)) throw new Error('Invalid data format in repo');

    // Merge: pulled entries overwrite existing for same months
    const pullMonths=new Set(entries.map(e=>e.month));
    manualEntries=[...manualEntries.filter(e=>!pullMonths.has(e.month)),...entries];
    manualEntries.sort((a,b)=>a.month.localeCompare(b.month));
    await saveToStorage();
    rebuildDFromManual();
    mergeAndRender(document.getElementById('fileBadge').textContent||'Manual Data');
    renderSavedEntriesList();
    refreshMonthSelects();

    ghSetStatus(`âœ… Pulled ${entries.length} entries  Â·  last pushed ${parsed.pushedAt?.slice(0,16)||'unknown'}`,'ok');
    toast(`â˜ï¸ Pulled ${entries.length} entries from GitHub`);
  }catch(err){
    ghSetStatus('âŒ Pull failed: '+err.message,'err');
    toast('âŒ GitHub pull failed',true);
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async () => {
  await loadFromStorage();
  if (manualEntries.length > 0) {
    mergeAndRender('Saved Data');
  }
})();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DROP / FILE HANDLING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const dropZone=document.getElementById('dropZone');
if(dropZone){
  dropZone.addEventListener('dragover',e=>{e.preventDefault();dropZone.classList.add('dragging');});
  dropZone.addEventListener('dragleave',()=>dropZone.classList.remove('dragging'));
  dropZone.addEventListener('drop',e=>{e.preventDefault();dropZone.classList.remove('dragging');handleFile(e.dataTransfer.files[0]);});
}
document.addEventListener('dragover',e=>{
  if(document.getElementById('dashboard').style.display!=='none'){e.preventDefault();document.getElementById('global-drop-overlay').classList.add('show');}
});
document.addEventListener('dragleave',e=>{
  if(!e.relatedTarget||e.relatedTarget===document.documentElement)document.getElementById('global-drop-overlay').classList.remove('show');
});
document.addEventListener('drop',e=>{
  e.preventDefault();document.getElementById('global-drop-overlay').classList.remove('show');
  if(document.getElementById('dashboard').style.display!=='none'&&e.dataTransfer.files[0])handleFile(e.dataTransfer.files[0]);
});

function handleFile(file) {
  if(!file)return;
  document.getElementById('loadingScreen').classList.add('show');
  document.getElementById('loaderText').textContent='Reading '+file.name+'â€¦';
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      // cellDates:false keeps date serial numbers as plain numbers â€” avoids Date objects corrupting num()
      const wb=XLSX.read(e.target.result,{type:'array',cellDates:false,cellNF:false,cellStyles:false});
      const xlData=parseWorkbook(wb);
      mergeExcelData(xlData);
      mergeAndRender(file.name);
      document.getElementById('loadingScreen').classList.remove('show');
      document.getElementById('drop-screen').style.display='none';
      document.getElementById('dashboard').style.display='block';
      document.getElementById('fileBadge').textContent=file.name;
      toast('ğŸ“Š Excel loaded: '+file.name);
    }catch(err){
      document.getElementById('loadingScreen').classList.remove('show');
      console.error('Excel load error:', err);
      toast('âŒ Load error: '+err.message,true);
    }
  };
  reader.onerror=()=>{
    document.getElementById('loadingScreen').classList.remove('show');
    toast('âŒ Could not read file',true);
  };
  reader.readAsArrayBuffer(file);
}

function startManual() {
  document.getElementById('drop-screen').style.display='none';
  document.getElementById('dashboard').style.display='block';
  openDrawer();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  WORKBOOK PARSING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function num(v){if(v==null)return null;const n=parseFloat(String(v).replace(/[^0-9.\-]/g,''));return isNaN(n)?null:n;}
function str(v){return v==null?'':String(v).trim();}

function findSheet(wb,candidates){
  for(const n of candidates)if(wb.Sheets[n])return n;
  const lower=candidates.map(c=>c.toLowerCase());
  for(const sn of wb.SheetNames)if(lower.some(c=>sn.toLowerCase().includes(c)))return sn;
  return null;
}

function parseSheet(wb, sheetCandidates, monthColHint='month') {
  const sn=findSheet(wb,sheetCandidates);
  if(!sn)return[];
  const raw=XLSX.utils.sheet_to_json(wb.Sheets[sn],{defval:null,raw:true,header:1});
  let hRow=-1;
  for(let i=0;i<raw.length;i++){
    if(raw[i]&&raw[i].some(c=>String(c||'').toLowerCase()===monthColHint)){hRow=i;break;}
  }
  if(hRow<0)return[];
  const headers=raw[hRow].map((h,i)=>({h:String(h||'').trim().toLowerCase(),i})).filter(x=>x.h);
  const ci=k=>{const f=headers.find(h=>h.h.includes(k.toLowerCase()));return f?f.i:-1;};
  return{raw,headers,hRow,ci};
}

function parseWorkbook(wb){
  const out={energy:[],water:[],food:[],earth:[],air:[],people:[],shelter:[],
             energyCluster:[],energyDaily:[],waterConsumption:[],waterQuality:[]};

  // â”€â”€ ENERGY DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const e=parseSheet(wb,['âš¡ Energy Dashboard','Energy Dashboard']);
  if(e&&e.raw){
    const {raw,hRow,ci}=e;
    for(let i=hRow+1;i<raw.length;i++){
      const r=raw[i]; if(!r)continue;
      const m=str(r[ci('month')]); if(!m||!m.match(/\d{4}/))continue;
      const solar=num(r[ci('solar')]);
      const eb=num(r[ci('eb')]);
      const dg=num(r[ci('dg')]);
      // "total consumed" cell may hold a string label on some rows â€” fallback to sum
      let total=num(r[ci('total')])||num(r[ci('consumed')]);
      if(total==null) total=(solar||0)+(eb||0)+(dg||0)||null;
      out.energy.push({month:m,solar,eb,dg,total,
        powerFactor:num(r[ci('power')]),
        status:str(r[ci('status')]),_src:'excel'});
    }
  }

  // â”€â”€ ENERGY DETAILED â€” cluster & daily â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const eSn=findSheet(wb,['Energy-Detailed','Energy Detailed']);
  if(eSn){
    try{
      const eRaw=XLSX.utils.sheet_to_json(wb.Sheets[eSn],{defval:null,raw:true,header:1});
      const clusterNames=['RP','MRP','GP','VP','MDP','CP','CHP','SP','TP'];

      // Find cluster section â€” first locate the "Clusterwise" heading, then find Month/Planned/Actual row after it
      let clusterSectionStart=-1;
      for(let i=0;i<eRaw.length;i++){
        if(eRaw[i]&&str(eRaw[i][0]).toLowerCase().includes('clusterwise')){clusterSectionStart=i;break;}
      }
      let clusterDataStart=-1;
      if(clusterSectionStart>=0){
        for(let i=clusterSectionStart;i<Math.min(clusterSectionStart+5,eRaw.length);i++){
          const r=eRaw[i]; if(!r)continue;
          const c0=str(r[0]).toLowerCase();
          const c1=str(r[1]).toLowerCase();
          const c2=str(r[2]).toLowerCase();
          if(c0==='month'&&c2==='actual'&&c1.includes('plan')){clusterDataStart=i+1;break;}
        }
        if(clusterDataStart<0) clusterDataStart=clusterSectionStart+3;
      }
      if(clusterDataStart>=0){
        for(let i=clusterDataStart;i<eRaw.length;i++){
          const r=eRaw[i]; if(!r)continue;
          const v0=r[0];
          // Stop if we hit a non-month string (section header) or run out of months
          if(v0==null||v0===0||(typeof v0==='string'&&!v0.match(/\d{4}/)))continue;
          if(typeof v0==='number')continue; // skip day-number rows
          const m=str(v0); if(!m.match(/\d{4}/)||m.toLowerCase().includes('daily')||m.toLowerCase().includes('analysis'))break;
          const entry={month:m,_src:'excel'};
          clusterNames.forEach((cl,idx)=>{ entry[cl]=num(r[idx*2+2])||null; });
          out.energyCluster.push(entry);
        }
      }

      // Dynamically find daily section â€” look for section header containing 'Daily' + 'EB'
      let dailyDataStart=-1;
      for(let i=0;i<eRaw.length;i++){
        const r=eRaw[i]; if(!r)continue;
        const c0=str(r[0]).toLowerCase();
        const c3=str(r[3]).toLowerCase();
        // Sub-header row: 'Date', 'Power', null, 'Date', 'Power'
        if(c0==='date'&&c3==='date'){
          dailyDataStart=i+1; break;
        }
      }
      if(dailyDataStart>=0){
        for(let i=dailyDataStart;i<eRaw.length;i++){
          const r=eRaw[i]; if(!r)continue;
          const d=Number(r[0]);
          if(!Number.isInteger(d)||d<1||d>31)continue;
          out.energyDaily.push({day:d,eb:num(r[1]),solar:num(r[4]),_src:'excel'});
        }
      }
    }catch(e){console.warn('Energy-Detailed parse error:',e.message);}
  }

  // â”€â”€ WATER DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // The data row is one column shorter than the header row:
  // Stability % header (col 9) contains the Status value in data; Status header (col 10) is blank.
  const w=parseSheet(wb,['ğŸ’§ Water Dashboard','Water Dashboard']);
  if(w&&w.raw){
    const {raw,hRow,ci}=w;
    for(let i=hRow+1;i<raw.length;i++){
      const r=raw[i]; if(!r)continue;
      const m=str(r[ci('month')]); if(!m||!m.match(/\d{4}/))continue;
      const bw=num(r[ci('borewell')]);
      const dw1=num(r[ci('dug well 1')])||num(r[ci('dug well1')]);
      const dw2=num(r[ci('dug well 2')])||num(r[ci('dug well2')]);
      const mb=num(r[ci('mission')]);
      const tot=num(r[ci('total')])||num(r[ci('supply')])||(bw||0)+(dw1||0)+(dw2||0)+(mb||0)||null;
      // If Stability % cell holds a non-number (status icon), fall back to Variance % col
      const stabIdx=ci('stability');
      const stabRaw=r[stabIdx];
      const stability=typeof stabRaw==='number'?stabRaw:num(r[ci('variance %')]);
      // Status: if declared col is blank/null, use stability col (data shifted left by 1)
      const statIdx=ci('status');
      let status=str(r[statIdx]);
      if(!status&&stabIdx>=0)status=str(r[stabIdx]);
      out.water.push({month:m,borewell:bw,dugWell1:dw1,dugWell2:dw2,missionBhag:mb,
        total:tot,stability,status,_src:'excel'});
    }
  }

  // â”€â”€ WATER DETAILED â€” consumption & quality â”€â”€â”€â”€
  const wSn=findSheet(wb,['Water-Detailed','Water Detailed']);
  if(wSn){
    try{
      const wRaw=XLSX.utils.sheet_to_json(wb.Sheets[wSn],{defval:null,raw:true,header:1});
      // Table 2: Consumption Balance Sheet
      let wConsumHdr=-1;
      for(let i=0;i<wRaw.length;i++){
        if(wRaw[i]&&str(wRaw[i][0]).toLowerCase().includes('consumption balance')){wConsumHdr=i+2;break;}
      }
      if(wConsumHdr>=0){
        for(let i=wConsumHdr;i<wRaw.length;i++){
          const r=wRaw[i]; if(!r)continue;
          const m=str(r[0]);
          if(!m||!m.match(/\d{4}/)){
            if(m.toLowerCase().includes('water quality')||m.toLowerCase().includes('quality report'))break;
            continue;
          }
          out.waterConsumption.push({month:m,category:str(r[1]),location:str(r[2]),
            planned:num(r[3]),actual:num(r[4]),variance:num(r[5]),variancePct:num(r[6]),status:str(r[8])});
        }
      }
      // Table 3: Water Quality Report
      let wQualHdr=-1;
      for(let i=0;i<wRaw.length;i++){
        if(wRaw[i]&&str(wRaw[i][0]).toLowerCase().includes('water quality')){wQualHdr=i+2;break;}
      }
      if(wQualHdr>=0){
        for(let i=wQualHdr;i<wRaw.length;i++){
          const r=wRaw[i]; if(!r)continue;
          const m=str(r[0]); if(!m||!m.match(/\d{4}/))continue;
          out.waterQuality.push({month:m,waterType:str(r[1]),ph:num(r[2]),
            tds:num(r[3]),turbidity:num(r[4]),chlorine:num(r[5]),
            ecoli:str(r[6]),compliancePct:num(r[7]),status:str(r[8])});
        }
      }
    }catch(e){console.warn('Water-Detailed parse error:',e.message);}
  }

  // â”€â”€ FOOD DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const f=parseSheet(wb,['ğŸŒ± Food Dashboard','Food Dashboard']);
  if(f&&f.raw){
    const {raw,hRow,ci}=f;
    for(let i=hRow+1;i<raw.length;i++){
      const r=raw[i]; if(!r)continue;
      const m=str(r[ci('month')]); if(!m||!m.match(/\d{4}/))continue;
      const planned=num(r[ci('planned')]),actual=num(r[ci('actual')]);
      // Families served may hold a status icon 'âšª' when not yet filled â€” guard with typeof
      const famRaw=r[ci('families')]||r[ci('served')];
      const families=typeof famRaw==='number'?famRaw:null;
      out.food.push({month:m,planned,actual,
        variance:planned!=null&&actual!=null?actual-planned:null,
        families,status:str(r[ci('status')]),_src:'excel'});
    }
  }

  // â”€â”€ EARTH DETAILED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const ea=parseSheet(wb,['Earth-Detailed','Earth Detailed']);
  if(ea&&ea.raw){
    const {raw,hRow,ci}=ea;
    for(let i=hRow+1;i<raw.length;i++){
      const r=raw[i]; if(!r)continue;
      const m=str(r[ci('month')]); if(!m||!m.match(/\d{4}/))continue;
      const wt=str(r[ci('waste type')])||str(r[ci('type')]); if(!wt)continue;
      const prod=num(r[ci('produced')]),reused=num(r[ci('reused')]);
      let reuseP=prod>0&&reused!=null?Math.round((reused/prod)*100):num(r[ci('reuse')]);
      if(reuseP!=null&&reuseP>0&&reuseP<=1)reuseP=Math.round(reuseP*100);
      out.earth.push({month:m,wasteType:wt,produced:prod,reused,
        processed:num(r[ci('processed')]),residue:num(r[ci('residue')]),
        reuseP,status:str(r[ci('status')]),_src:'excel'});
    }
  }

  // â”€â”€ AIR DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const airSn=findSheet(wb,['ğŸ’¨ Air Dashboard','Air-Summary','Air Dashboard']);
  if(airSn){
    const raw=XLSX.utils.sheet_to_json(wb.Sheets[airSn],{defval:null,raw:true,header:1});
    let hRow=-1;
    for(let i=0;i<raw.length;i++){
      if(raw[i]&&raw[i].some(c=>String(c||'').toLowerCase().includes('month'))){hRow=i;break;}
    }
    if(hRow>=0){
      const hdrs=raw[hRow].map((h,i)=>({h:String(h||'').trim().toLowerCase(),i})).filter(x=>x.h);
      const ci=k=>{const f=hdrs.find(h=>h.h.includes(k));return f?f.i:-1;};
      for(let i=hRow+1;i<raw.length;i++){
        const r=raw[i]; if(!r)continue;
        const m=str(r[ci('month')]); if(!m||!m.match(/\d{4}/))continue;
        // Location stored as 0 (number placeholder) when empty â€” treat as blank string
        const locRaw=r[ci('location')];
        const location=locRaw&&typeof locRaw==='string'?locRaw:'';
        out.air.push({month:m,
          pm25:num(r[ci('pm2.5')])||num(r[ci('pm25')]),
          pm10:num(r[ci('pm10')]),
          aqi:num(r[ci('avg aqi')])||num(r[ci('aqi')]),
          location,_src:'excel'});
      }
    }
  }

  // â”€â”€ PEOPLE DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const p=parseSheet(wb,['ğŸ‘¥ People Dashboard','People Dashboard']);
  if(p&&p.raw){
    const {raw,hRow,ci}=p;
    for(let i=hRow+1;i<raw.length;i++){
      const r=raw[i]; if(!r)continue;
      const m=str(r[ci('month')]); if(!m||!m.match(/\d{4}/))continue;
      const total=num(r[ci('total')]),occupied=num(r[ci('occupied')]);
      // Occupancy % stored as decimal 0.247 â†’ convert to percentage
      let occ=num(r[ci('occupancy')]);
      if(occ!=null&&occ<=1)occ=Math.round(occ*100*10)/10;
      out.people.push({month:m,total,occupied,
        occupancyPct:total>0&&occupied!=null?(occupied/total)*100:occ,
        plannedFootfall:num(r[ci('planned')]),
        actualFootfall:num(r[ci('actual')]),
        status:str(r[ci('status')]),_src:'excel'});
    }
  }

  // â”€â”€ SHELTER DASHBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const sh=parseSheet(wb,['ğŸ  Shelter Dashboard','Shelter Dashboard']);
  if(sh&&sh.raw){
    const {raw,hRow,ci}=sh;
    for(let i=hRow+1;i<raw.length;i++){
      const r=raw[i]; if(!r)continue;
      const m=str(r[ci('month')]); if(!m||!m.match(/\d{4}/))continue;
      const planned=num(r[ci('planned')]),completed=num(r[ci('completed')]);
      // Civil/Landscape/Pest stored as decimals (0.21) â†’ multiply by 100
      const toP=v=>v==null?null:(v>0&&v<=1?Math.round(v*100):Math.round(v));
      out.shelter.push({month:m,planned,completed,
        completionPct:planned>0&&completed!=null?(completed/planned)*100:null,
        civilPct:toP(num(r[ci('civil')])),
        landscapePct:toP(num(r[ci('landscape')])),
        pestPct:toP(num(r[ci('pest')])),
        status:str(r[ci('status')]),_src:'excel'});
    }
  }

  return out;
}


function mergeExcelData(xlData) {
  // Standard month-keyed arrays â€” excel takes priority, keep manual for months not in excel
  for(const key of ['energy','water','food','earth','air','people','shelter']){
    if(!xlData[key]) continue;
    const xl=xlData[key].filter(r=>r.month&&r.month.match(/\d{4}/));
    const manual=(D[key]||[]).filter(r=>r._src==='manual');
    const excelMonths=new Set(xl.map(r=>r.month));
    D[key]=[...xl,...manual.filter(r=>!excelMonths.has(r.month))];
    D[key].sort((a,b)=>a.month.localeCompare(b.month));
  }
  // Non-month-keyed arrays â€” just copy directly from excel
  if(xlData.energyCluster) D.energyCluster=xlData.energyCluster;
  if(xlData.energyDaily)   D.energyDaily=xlData.energyDaily;
  if(xlData.waterConsumption) D.waterConsumption=xlData.waterConsumption;
  if(xlData.waterQuality)  D.waterQuality=xlData.waterQuality;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MANUAL ENTRY â€” DRAWER LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openClearModal(){
  document.getElementById('clearModal').classList.add('show');
}
function closeClearModal(){
  document.getElementById('clearModal').classList.remove('show');
}
async function confirmClearData(){
  const clrExcel  = document.getElementById('clr-excel').checked;
  const clrManual = document.getElementById('clr-manual').checked;
  if(!clrExcel && !clrManual){ closeClearModal(); return; }

  const allKeys=['energy','water','food','earth','air','people','shelter',
                 'energyCluster','energyDaily','waterConsumption','waterQuality'];

  if(clrExcel && clrManual){
    // Wipe everything
    allKeys.forEach(k=>D[k]=[]);
    manualEntries=[];
  } else if(clrExcel){
    // Keep only manual-sourced rows
    allKeys.forEach(k=>{ if(D[k]) D[k]=D[k].filter(r=>r._src==='manual'); });
  } else if(clrManual){
    // Keep only excel-sourced rows
    allKeys.forEach(k=>{ if(D[k]) D[k]=D[k].filter(r=>r._src==='excel'); });
    manualEntries=[];
  }

  if(clrManual) await saveToStorage();

  // Reset file badge if excel cleared
  if(clrExcel) document.getElementById('fileBadge').textContent='Manual Data';

  closeClearModal();

  // If everything is cleared, go back to drop screen
  const hasAnyData = D.energy.length>0||D.water.length>0||D.food.length>0||
                     D.earth.length>0||D.air.length>0||D.people.length>0||D.shelter.length>0;
  if(!hasAnyData){
    document.getElementById('dashboard').style.display='none';
    document.getElementById('drop-screen').style.display='flex';
    toast('ğŸ—‘ï¸ All data cleared');
    return;
  }

  rebuildDFromManual();
  mergeAndRender(document.getElementById('fileBadge').textContent);
  const what = clrExcel&&clrManual?'All data':clrExcel?'Excel data':'Manual entries';
  toast(`ğŸ—‘ï¸ ${what} cleared`);
}

// Close modal on backdrop click
document.getElementById('clearModal').addEventListener('click',function(e){
  if(e.target===this) closeClearModal();
});
document.getElementById('ghModal').addEventListener('click',function(e){
  if(e.target===this) closeGHModal();
});

function openDrawer(){
  document.getElementById('entry-overlay').classList.add('open');
  document.getElementById('entry-drawer').classList.add('open');
  document.body.style.overflow='hidden';
  buildDailyGrid();
  buildFoodGrid();
  buildBioGrid();
  refreshMonthSelects();
  renderSavedEntriesList();
}
function closeDrawer(){
  document.getElementById('entry-overlay').classList.remove('open');
  document.getElementById('entry-drawer').classList.remove('open');
  document.body.style.overflow='';
}

function switchDrawerTab(tab, el){
  document.querySelectorAll('.dp-tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.dp-panel').forEach(p=>p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('dp'+tab.charAt(0).toUpperCase()+tab.slice(1)).classList.add('active');
}

function refreshMonthSelects(){
  const allMonths=[...new Set([
    ...D.energy.map(r=>r.month),...D.water.map(r=>r.month),
    ...D.food.map(r=>r.month),...D.people.map(r=>r.month),
    ...manualEntries.map(e=>e.month)
  ])].sort();
  const sel=document.getElementById('monthSelect');
  sel.innerHTML='<option value="">Load existingâ€¦</option>'+allMonths.map(m=>`<option>${m}</option>`).join('');
  const dl=document.getElementById('existingMonths');
  dl.innerHTML=allMonths.map(m=>`<option value="${m}">`).join('');

  // Dot tabs for pillars with data
  const tabNames=['energy','water','food','earth','air','people','shelter'];
  tabNames.forEach(t=>{
    const tab=document.querySelector(`.dp-tab[onclick*="'${t}'"]`);
    if(!tab)return;
    const hasData=manualEntries.some(e=>e[t]&&Object.values(e[t]).some(v=>v!=null&&v!==''));
    tab.classList.toggle('has-data',hasData);
  });
}

function loadMonthIntoForm(month){
  if(!month)return;
  document.getElementById('entryMonth').value=month;
  const entry=manualEntries.find(e=>e.month===month)||{};
  // Energy
  setF('f_solar',entry.energy?.solar);setF('f_eb',entry.energy?.eb);setF('f_dg',entry.energy?.dg);
  setF('f_e_villas',entry.energy?.villas);setF('f_e_common',entry.energy?.common);
  setF('f_pf',entry.energy?.powerFactor);setF('f_e_status',entry.energy?.status,'select');
  // Cluster
  ['RP','MRP','GP','VP','MDP','CP','CHP','SP','TP'].forEach(c=>setF('f_cl_'+c,entry.energy?.cluster?.[c]));
  updateClusterCalc();
  // Daily
  buildDailyGrid();
  for(let d=1;d<=31;d++){setF('f_eb_d'+d,entry.energy?.daily?.[d]?.eb);setF('f_sol_d'+d,entry.energy?.daily?.[d]?.solar);}
  updateDailyCalc();
  // Water sources
  setF('f_dw1',entry.water?.dugWell1);setF('f_borewell',entry.water?.borewell);
  setF('f_dw2',entry.water?.dugWell2);setF('f_mb',entry.water?.missionBhag);
  setF('f_days_unavail',entry.water?.daysUnavail);setF('f_w_status',entry.water?.status,'select');
  // Water consumption balance
  const wCats=['villa','irrig','rhive','goo','pool','land'];
  const wLabels=['Per Villa â€” Domestic','Per Villa â€” Irrigation','Rurban Hive','GOO','Swimming Pool','Landscaping & Farming'];
  wCats.forEach((c,i)=>{
    const row=(entry.water?.consumption||[]).find(r=>r.category===wLabels[i]);
    setF('f_wc_'+c+'_p',row?.planned); setF('f_wc_'+c+'_a',row?.actual);
  });
  updateWaterCalc(); updateWaterConsumCalc();
  // Water quality
  const wqIds=['pool','wtp','dw1','dw2','tert'];
  const wqLabels=['Swimming Pool','WTP','Dug Well 1','Dug Well 2','Tertiary Plant'];
  wqIds.forEach((id,i)=>{
    const row=(entry.water?.quality||[]).find(r=>r.location===wqLabels[i]);
    setF('f_wq_'+id+'_ph',row?.ph);setF('f_wq_'+id+'_tds',row?.tds);
    setF('f_wq_'+id+'_turb',row?.turbidity);setF('f_wq_'+id+'_cl',row?.chlorine);
    const ec=document.getElementById('f_wq_'+id+'_ecoli');if(ec)ec.value=row?.ecoli||'';
    setF('f_wq_'+id+'_st',row?.status,'select');
  });
  // Food crops
  buildFoodGrid();
  (entry.food?.crops||[]).forEach((crop,i)=>{
    if(i>=30)return;
    const n=i+1;
    const nameEl=document.getElementById('f_crop_name_'+n); if(nameEl)nameEl.value=crop.name||'';
    setF('f_crop_type_'+n,crop.type,'select');
    setF('f_crop_plan_'+n,crop.planned); setF('f_crop_act_'+n,crop.actual);
  });
  setF('f_families',entry.food?.families); setF('f_f_status',entry.food?.status,'select');
  updateFoodCalc();
  // Earth wastes
  const wasteMap={Organic:'organic',Plastic:'plastic','E-Waste':'ewaste',Construction:'const',Paper:'paper',Glass:'glass'};
  (entry.earth?.wastes||[]).forEach(w=>{
    const id=wasteMap[w.type]; if(!id)return;
    setF('f_ea_'+id+'_prod',w.produced);setF('f_ea_'+id+'_reused',w.reused);setF('f_ea_'+id+'_proc',w.processed);
  });
  setF('f_greencover',entry.earth?.greenCover); setF('f_ea_status',entry.earth?.status,'select');
  updateEarthCalc();
  // Biodiversity
  buildBioGrid();
  (entry.earth?.biodiversity||[]).forEach((b,i)=>{
    if(i>=10)return; const n=i+1;
    const el=document.getElementById('f_bio_type_'+n); if(el)el.value=b.indicator||'';
    setF('f_bio_count_'+n,b.count);
  });
  // Air
  setF('f_location',entry.air?.location,'select');
  setF('f_pm_w1',entry.air?.pmW1);setF('f_pm_w2',entry.air?.pmW2);setF('f_pm_w3',entry.air?.pmW3);setF('f_pm_w4',entry.air?.pmW4);
  setF('f_aqi_w1',entry.air?.aqiW1);setF('f_aqi_w2',entry.air?.aqiW2);setF('f_aqi_w3',entry.air?.aqiW3);setF('f_aqi_w4',entry.air?.aqiW4);
  setF('f_pm10',entry.air?.pm10);setF('f_co2',entry.air?.co2);setF('f_air_status',entry.air?.status,'select');
  updateAirCalc();
  // People
  setF('f_total_villas',entry.people?.totalVillas||182);setF('f_occupied',entry.people?.occupied);
  setF('f_plan_ft',entry.people?.plannedFootfall);setF('f_act_ft',entry.people?.actualFootfall);
  setF('f_events',entry.people?.events);setF('f_p_status',entry.people?.status,'select');
  // Shelter
  setF('f_planned_tasks',entry.shelter?.plannedTasks);setF('f_done_tasks',entry.shelter?.completedTasks);
  setF('f_civil',entry.shelter?.civilPct);setF('f_landscape',entry.shelter?.landscapePct);
  setF('f_pest',entry.shelter?.pestPct);setF('f_sh_status',entry.shelter?.status,'select');
  updatePeopleCalc();updateShelterCalc();
}

function setF(id,val,type='input'){
  const el=document.getElementById(id);
  if(!el)return;
  if(val!=null&&val!=='')el.value=val; else el.value='';
}

function clearForm(){
  // Basic numeric + select fields
  ['f_solar','f_eb','f_dg','f_e_villas','f_e_common','f_pf',
   'f_dw1','f_borewell','f_dw2','f_mb','f_days_unavail',
   'f_families',
   'f_greencover',
   'f_pm_w1','f_pm_w2','f_pm_w3','f_pm_w4',
   'f_aqi_w1','f_aqi_w2','f_aqi_w3','f_aqi_w4',
   'f_pm10','f_co2',
   'f_total_villas','f_occupied','f_plan_ft','f_act_ft','f_events',
   'f_planned_tasks','f_done_tasks','f_civil','f_landscape','f_pest'
  ].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  ['f_e_status','f_w_status','f_f_status','f_ea_status','f_air_status','f_p_status','f_sh_status','f_location']
  .forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  // Cluster
  ['RP','MRP','GP','VP','MDP','CP','CHP','SP','TP'].forEach(c=>{const el=document.getElementById('f_cl_'+c);if(el)el.value='';});
  // Daily energy
  for(let d=1;d<=31;d++){['f_eb_d'+d,'f_sol_d'+d].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});}
  // Water consumption balance
  ['villa','irrig','rhive','goo','pool','land'].forEach(c=>{
    ['p','a'].forEach(s=>{const el=document.getElementById('f_wc_'+c+'_'+s);if(el)el.value='';});
  });
  // Water quality
  ['pool','wtp','dw1','dw2','tert'].forEach(l=>{
    ['ph','tds','turb','cl'].forEach(p=>{const el=document.getElementById('f_wq_'+l+'_'+p);if(el)el.value='';});
    const ec=document.getElementById('f_wq_'+l+'_ecoli');if(ec)ec.value='';
    const st=document.getElementById('f_wq_'+l+'_st');if(st)st.value='';
  });
  // Food crops
  for(let n=1;n<=30;n++){
    const nm=document.getElementById('f_crop_name_'+n);if(nm)nm.value='';
    const tp=document.getElementById('f_crop_type_'+n);if(tp)tp.value='';
    ['f_crop_plan_'+n,'f_crop_act_'+n].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  }
  // Earth wastes
  ['organic','plastic','ewaste','const','paper','glass'].forEach(t=>{
    ['prod','reused','proc'].forEach(s=>{const el=document.getElementById('f_ea_'+t+'_'+s);if(el)el.value='';});
  });
  // Biodiversity
  for(let n=1;n<=10;n++){
    const bt=document.getElementById('f_bio_type_'+n);if(bt)bt.value='';
    const bc=document.getElementById('f_bio_count_'+n);if(bc)bc.value='';
  }
  document.getElementById('entryMonth').value='';
  updateEnergyCalc();updateClusterCalc();updateDailyCalc();
  updateWaterCalc();updateWaterConsumCalc();
  updateFoodCalc();updateEarthCalc();updateAirCalc();
  updatePeopleCalc();updateShelterCalc();
}

function getN(id){return num(document.getElementById(id)?.value)||0;}
function getS(id){return str(document.getElementById(id)?.value);}

// Live computed previews
// Build the 31-day input grid once
function buildDailyGrid(){
  const grid=document.getElementById('dailyInputGrid');
  if(!grid||grid.children.length>0)return;
  const inputStyle='background:var(--bg3);border:1px solid var(--border);border-radius:5px;padding:5px 6px;color:var(--text);font-family:var(--mono);font-size:11px;outline:none;width:100%;transition:border-color 0.15s;';
  let html='';
  for(let d=1;d<=31;d++){
    html+=`<div style="font-size:10px;font-family:var(--mono);color:var(--text3);text-align:center;padding-top:4px">${d}</div>`;
    html+=`<input type="number" id="f_eb_d${d}" placeholder="â€”" style="${inputStyle}" oninput="updateDailyCalc()">`;
    html+=`<input type="number" id="f_sol_d${d}" placeholder="â€”" style="${inputStyle.replace(C.blue,'var(--amber)')}" oninput="updateDailyCalc()">`;
  }
  grid.innerHTML=html;
}

function updateClusterCalc(){
  const clusters=['RP','MRP','GP','VP','MDP','CP','CHP','SP','TP'];
  const vals=clusters.map(c=>parseFloat(document.getElementById('f_cl_'+c)?.value)||0);
  const tot=vals.reduce((a,b)=>a+b,0);
  const top=clusters.map((c,i)=>({c,v:vals[i]})).filter(x=>x.v>0).sort((a,b)=>b.v-a.v).slice(0,3);
  document.getElementById('clusterCalc').innerHTML=tot>0
    ?`<div class="computed-chip">Total <strong>${fmt(tot)} kWh</strong></div>`
     +top.map(x=>`<div class="computed-chip">${x.c} <strong>${fmt(x.v)}</strong></div>`).join('')
    :'';
}

function updateDailyCalc(){
  let ebSum=0,solSum=0,ebCount=0,solCount=0;
  for(let d=1;d<=31;d++){
    const eb=parseFloat(document.getElementById('f_eb_d'+d)?.value);
    const sol=parseFloat(document.getElementById('f_sol_d'+d)?.value);
    if(!isNaN(eb)&&eb>0){ebSum+=eb;ebCount++;}
    if(!isNaN(sol)&&sol>0){solSum+=sol;solCount++;}
  }
  document.getElementById('dailyCalc').innerHTML=(ebCount+solCount)>0
    ?`<div class="computed-chip">EB Total <strong>${fmt(ebSum)} kWh</strong> (${ebCount} days)</div>`
     +`<div class="computed-chip">Solar Total <strong>${fmt(solSum)} kWh</strong> (${solCount} days)</div>`
    :'';
}

function updateEnergyCalc(){
  const s=getN('f_solar'),eb=getN('f_eb'),dg=getN('f_dg'),tot=s+eb+dg;
  document.getElementById('energyCalc').innerHTML=tot>0?
    `<div class="computed-chip">Total <strong>${fmt(tot)} kWh</strong></div>
     <div class="computed-chip">Solar <strong>${pct(tot>0?(s/tot)*100:0)}</strong></div>
     <div class="computed-chip">DG <strong>${pct(tot>0?(dg/tot)*100:0)}</strong></div>`:'';
}
function updateWaterCalc(){
  const dw1=getN('f_dw1'),bw=getN('f_borewell'),dw2=getN('f_dw2'),mb=getN('f_mb');
  const tot=dw1+bw+dw2+mb;
  const days=getN('f_days_unavail');
  const stab=Math.max(0,100-days*3.33);
  document.getElementById('waterCalc').innerHTML=tot>0?
    `<div class="computed-chip">Total <strong>${fmt(tot)} KL</strong></div>
     <div class="computed-chip">Stability <strong>${stab.toFixed(0)}%</strong></div>`:'';
}
function updateWaterConsumCalc(){
  const cats=['villa','irrig','rhive','goo','pool','land'];
  let totalP=0,totalA=0;
  cats.forEach(c=>{
    const p=getN('f_wc_'+c+'_p'),a=getN('f_wc_'+c+'_a');
    totalP+=p; totalA+=a;
    const v=document.getElementById('wc_'+c+'_v');
    if(v){const diff=a-p;v.textContent=(p||a)?(diff>=0?'+':'')+diff.toFixed(1):'â€”';v.style.color=diff>=0?'var(--accent)':'var(--amber)';}
  });
  document.getElementById('waterConsumCalc').innerHTML=(totalA>0)?
    `<div class="computed-chip">Total Planned <strong>${fmt(totalP)} KL</strong></div>
     <div class="computed-chip">Total Actual <strong>${fmt(totalA)} KL</strong></div>`:'';
}
function buildFoodGrid(){
  const tbody=document.getElementById('foodCropGrid');
  if(!tbody||tbody.children.length>0)return;
  const types=['','Vegetable','Leafies','Fruits','Micro greens','Intercrop'];
  const opts=types.map(t=>`<option value="${t}">${t||'â€” type â€”'}</option>`).join('');
  const iS='width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:5px;padding:4px 6px;color:var(--text);font-family:var(--mono);font-size:10px;outline:none;';
  let html='';
  for(let n=1;n<=30;n++){
    html+=`<tr>
      <td><input type="text" id="f_crop_name_${n}" placeholder="Crop ${n}" style="${iS}" oninput="updateFoodCalc()"></td>
      <td><select id="f_crop_type_${n}" style="${iS}cursor:pointer;appearance:none;background-image:url('data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%228%22 height=%225%22%3E%3Cpath d=%22M0 0l4 5 4-5z%22 fill=%22%236a9a80%22/%3E%3C/svg%3E');background-repeat:no-repeat;background-position:right 5px center;padding-right:16px;">${opts}</select></td>
      <td><input type="number" id="f_crop_plan_${n}" placeholder="0" style="${iS}" oninput="updateFoodCalc()"></td>
      <td><input type="number" id="f_crop_act_${n}" placeholder="0" style="${iS}" oninput="updateFoodCalc()"></td>
      <td class="var-cell" id="f_crop_var_${n}">â€”</td>
    </tr>`;
  }
  tbody.innerHTML=html;
}
function updateFoodCalc(){
  let totP=0,totA=0,count=0;
  for(let n=1;n<=30;n++){
    const p=getN('f_crop_plan_'+n),a=getN('f_crop_act_'+n);
    totP+=p; totA+=a;
    if(p||a) count++;
    const v=document.getElementById('f_crop_var_'+n);
    if(v){const diff=a-p;v.textContent=(p||a)?(diff>=0?'+':'')+diff.toFixed(1):'â€”';v.style.color=diff>=0?'var(--accent)':'var(--amber)';}
  }
  const ach=totP>0?Math.round((totA/totP)*100):0;
  document.getElementById('foodCalc').innerHTML=count>0?
    `<div class="computed-chip">${count} crops Â· Planned <strong>${fmt(totP)} kg</strong></div>
     <div class="computed-chip">Actual <strong>${fmt(totA)} kg</strong></div>
     <div class="computed-chip">Achievement <strong style="color:${ach>=85?'var(--accent)':ach>=70?'var(--amber)':'var(--red)'}">${ach}%</strong></div>`:'';
}
function buildBioGrid(){
  const tbody=document.getElementById('bioGrid');
  if(!tbody||tbody.children.length>0)return;
  const iS='width:100%;background:var(--bg3);border:1px solid var(--border);border-radius:5px;padding:4px 6px;color:var(--text);font-family:var(--mono);font-size:10px;outline:none;';
  let html='';
  for(let n=1;n<=10;n++){
    html+=`<tr>
      <td style="width:65%"><input type="text" id="f_bio_type_${n}" placeholder="e.g. Birds, Butterfliesâ€¦" style="${iS}"></td>
      <td><input type="number" id="f_bio_count_${n}" placeholder="0" style="${iS}text-align:center;"></td>
    </tr>`;
  }
  tbody.innerHTML=html;
}
function updateEarthCalc(){
  const types=['organic','plastic','ewaste','const','paper','glass'];
  let totProd=0,totReused=0,totProc=0;
  types.forEach(t=>{
    const prod=getN('f_ea_'+t+'_prod'),reused=getN('f_ea_'+t+'_reused'),proc=getN('f_ea_'+t+'_proc');
    const res=Math.max(0,prod-reused-proc);
    totProd+=prod; totReused+=reused; totProc+=proc;
    const el=document.getElementById('ea_'+t+'_res');
    if(el) el.textContent=prod>0?res.toFixed(1):'â€”';
  });
  const rp=totProd>0?Math.round((totReused/totProd)*100):0;
  document.getElementById('earthCalc').innerHTML=totProd>0?
    `<div class="computed-chip">Total Waste <strong>${fmt(totProd)} kg</strong></div>
     <div class="computed-chip">Reuse <strong style="color:${rp>=80?'var(--accent)':rp>=60?'var(--amber)':'var(--red)'}">${rp}%</strong></div>
     <div class="computed-chip">Residue <strong style="color:var(--amber)">${fmt(Math.max(0,totProd-totReused-totProc))} kg</strong></div>`:'';
}
function updateAirCalc(){
  const pmVals=[getN('f_pm_w1'),getN('f_pm_w2'),getN('f_pm_w3'),getN('f_pm_w4')].filter(v=>v>0);
  const aqiVals=[getN('f_aqi_w1'),getN('f_aqi_w2'),getN('f_aqi_w3'),getN('f_aqi_w4')].filter(v=>v>0);
  let chips='';
  if(pmVals.length>0){
    const avg=pmVals.reduce((a,b)=>a+b,0)/pmVals.length;
    chips+=`<div class="computed-chip">Avg PM2.5 <strong>${avg.toFixed(1)} Âµg/mÂ³</strong></div>`;
  }
  if(aqiVals.length>0){
    const avgAqi=aqiVals.reduce((a,b)=>a+b,0)/aqiVals.length;
    chips+=`<div class="computed-chip">Avg AQI <strong style="color:${avgAqi<=50?'var(--accent)':avgAqi<=100?'var(--amber)':'var(--red)'}">${avgAqi.toFixed(0)}</strong></div>`;
  } else if(pmVals.length>0){
    const avg=pmVals.reduce((a,b)=>a+b,0)/pmVals.length;
    const aqi=avg<=12?Math.round((avg/12)*50):avg<=35.4?Math.round(51+(avg-12.1)/(35.4-12.1)*49):Math.round(101+(avg-35.5)/(55.4-35.5)*49);
    chips+=`<div class="computed-chip">Est. AQI <strong style="color:${aqi<=50?'var(--accent)':aqi<=100?'var(--amber)':'var(--red)'}">${aqi}</strong></div>`;
  }
  document.getElementById('airCalc').innerHTML=chips;
}
function updatePeopleCalc(){
  const tot=getN('f_total_villas')||182,occ=getN('f_occupied');
  const op=tot>0?((occ/tot)*100).toFixed(1):0;
  document.getElementById('peopleCalc').innerHTML=occ>0?
    `<div class="computed-chip">Occupancy <strong>${op}%</strong></div>
     <div class="computed-chip">Vacant <strong>${tot-occ}</strong></div>`:'';
}
function updateShelterCalc(){
  const p=getN('f_planned_tasks'),d=getN('f_done_tasks');
  const cp=p>0?Math.round((d/p)*100):0;
  document.getElementById('shelterCalc').innerHTML=p>0?
    `<div class="computed-chip">Completion <strong>${cp}%</strong></div>
     <div class="computed-chip">Remaining <strong>${p-d} tasks</strong></div>`:'';
}

async function saveEntry(){
  const month=document.getElementById('entryMonth').value.trim();
  if(!month){toast('âš ï¸ Enter a month first (e.g. Feb-2026)',true);return;}

  const autoStatus=(score,g=80,a=60)=>score>=g?'Green':score>=a?'Amber':'Red';

  // â”€â”€ Energy â”€â”€
  const s=getN('f_solar'),eb=getN('f_eb'),dg=getN('f_dg');
  const tot=s+eb+dg;
  const clusterNames=['RP','MRP','GP','VP','MDP','CP','CHP','SP','TP'];
  const cluster={}; clusterNames.forEach(c=>{const v=getN('f_cl_'+c);if(v>0)cluster[c]=v;});
  const daily={}; for(let d=1;d<=31;d++){const eb2=getN('f_eb_d'+d),sol=getN('f_sol_d'+d);if(eb2>0||sol>0)daily[d]={eb:eb2||null,solar:sol||null};}

  // â”€â”€ Water â”€â”€
  const dw1=getN('f_dw1'),bw=getN('f_borewell'),dw2=getN('f_dw2'),mb=getN('f_mb');
  const wTot=dw1+bw+dw2+mb;
  const days=getN('f_days_unavail');
  // Consumption balance
  const wCats=[
    {id:'villa',label:'Per Villa â€” Domestic'},
    {id:'irrig',label:'Per Villa â€” Irrigation'},
    {id:'rhive',label:'Rurban Hive'},
    {id:'goo',  label:'GOO'},
    {id:'pool', label:'Swimming Pool'},
    {id:'land', label:'Landscaping & Farming'},
  ];
  const consumption=wCats.map(c=>({category:c.label,planned:getN('f_wc_'+c.id+'_p')||null,actual:getN('f_wc_'+c.id+'_a')||null})).filter(c=>c.planned||c.actual);
  // Quality
  const wqLocs=[{id:'pool',label:'Swimming Pool'},{id:'wtp',label:'WTP'},{id:'dw1',label:'Dug Well 1'},{id:'dw2',label:'Dug Well 2'},{id:'tert',label:'Tertiary Plant'}];
  const quality=wqLocs.map(l=>({
    location:l.label,
    ph:getN('f_wq_'+l.id+'_ph')||null,tds:getN('f_wq_'+l.id+'_tds')||null,
    turbidity:getN('f_wq_'+l.id+'_turb')||null,chlorine:getN('f_wq_'+l.id+'_cl')||null,
    ecoli:document.getElementById('f_wq_'+l.id+'_ecoli')?.value.trim()||null,
    status:getS('f_wq_'+l.id+'_st')
  })).filter(l=>l.ph||l.tds||l.turbidity||l.ecoli||l.status);

  // â”€â”€ Food â”€â”€
  const crops=[];
  let totFoodP=0,totFoodA=0;
  for(let n=1;n<=30;n++){
    const name=document.getElementById('f_crop_name_'+n)?.value.trim();
    const type=getS('f_crop_type_'+n);
    const p=getN('f_crop_plan_'+n),a=getN('f_crop_act_'+n);
    if(name||type||p||a){crops.push({name:name||null,type:type||null,planned:p||null,actual:a||null});totFoodP+=p;totFoodA+=a;}
  }

  // â”€â”€ Earth â”€â”€
  const wasteTypes=[
    {id:'organic',label:'Organic'},{id:'plastic',label:'Plastic'},{id:'ewaste',label:'E-Waste'},
    {id:'const',label:'Construction'},{id:'paper',label:'Paper'},{id:'glass',label:'Glass'}
  ];
  const wastes=wasteTypes.map(t=>{
    const prod=getN('f_ea_'+t.id+'_prod'),reused=getN('f_ea_'+t.id+'_reused'),proc=getN('f_ea_'+t.id+'_proc');
    return {type:t.label,produced:prod||null,reused:reused||null,processed:proc||null,residue:Math.max(0,prod-reused-proc)||null};
  }).filter(w=>w.produced||w.reused||w.processed);
  const biodiversity=[];
  for(let n=1;n<=10;n++){
    const indicator=document.getElementById('f_bio_type_'+n)?.value.trim();
    const count=getN('f_bio_count_'+n);
    if(indicator||count) biodiversity.push({indicator:indicator||null,count:count||null});
  }
  // Derived totals for render compat
  const orgW=wastes.find(w=>w.type==='Organic')||{};
  const allProd=wastes.reduce((s,w)=>s+(w.produced||0),0);
  const allReused=wastes.reduce((s,w)=>s+(w.reused||0),0);

  // â”€â”€ Air â”€â”€
  const pm1=getN('f_pm_w1'),pm2=getN('f_pm_w2'),pm3=getN('f_pm_w3'),pm4=getN('f_pm_w4');
  const pmFilled=[pm1,pm2,pm3,pm4].filter(v=>v>0);
  const avgPm=pmFilled.length>0?pmFilled.reduce((a,b)=>a+b,0)/pmFilled.length:0;
  const aq1=getN('f_aqi_w1'),aq2=getN('f_aqi_w2'),aq3=getN('f_aqi_w3'),aq4=getN('f_aqi_w4');
  const aqFilled=[aq1,aq2,aq3,aq4].filter(v=>v>0);
  const avgAqi=aqFilled.length>0?aqFilled.reduce((a,b)=>a+b,0)/aqFilled.length:0;
  const calcAqi=avgAqi||( avgPm>0?(avgPm<=12?Math.round((avgPm/12)*50):avgPm<=35.4?Math.round(51+(avgPm-12.1)/(35.4-12.1)*49):Math.round(101+(avgPm-35.5)/(55.4-35.5)*49)):0 );

  const totalVillas=getN('f_total_villas')||182,occupied=getN('f_occupied');
  const ptasks=getN('f_planned_tasks'),dtasks=getN('f_done_tasks');

  const entry={
    month,
    energy:{ solar:s||null,eb:eb||null,dg:dg||null,total:tot||null,
      villas:getN('f_e_villas')||null,common:getN('f_e_common')||null,
      powerFactor:getN('f_pf')||null,
      cluster:Object.keys(cluster).length?cluster:null,
      daily:Object.keys(daily).length?daily:null,
      status:getS('f_e_status')||(tot>0?autoStatus(s/tot*100,10,3):'') },
    water:{ dugWell1:dw1||null,borewell:bw||null,dugWell2:dw2||null,missionBhag:mb||null,
      total:wTot||null,daysUnavail:days||null,
      stability:Math.max(0,100-days*3.33),
      consumption:consumption.length?consumption:null,
      quality:quality.length?quality:null,
      status:getS('f_w_status')||(wTot>0?autoStatus(Math.max(0,100-days*3.33)):'') },
    food:{ crops:crops.length?crops:null,
      planned:totFoodP||null,actual:totFoodA||null,
      variance:totFoodP&&totFoodA?totFoodA-totFoodP:null,
      families:getN('f_families')||null,
      status:getS('f_f_status')||(totFoodP>0?autoStatus((totFoodA/totFoodP)*100,85,70):'') },
    earth:{ wastes:wastes.length?wastes:null,biodiversity:biodiversity.length?biodiversity:null,
      organicProd:orgW.produced||null,organicReused:orgW.reused||null,organicProc:orgW.processed||null,
      recycleProd:allProd||null,
      reuseP:allProd>0?Math.round((allReused/allProd)*100):null,
      greenCover:getN('f_greencover')||null,
      status:getS('f_ea_status') },
    air:{ location:getS('f_location'),
      pmW1:pm1||null,pmW2:pm2||null,pmW3:pm3||null,pmW4:pm4||null,
      aqiW1:aq1||null,aqiW2:aq2||null,aqiW3:aq3||null,aqiW4:aq4||null,
      pm25:avgPm||null,pm10:getN('f_pm10')||null,co2:getN('f_co2')||null,
      aqi:calcAqi||null,
      status:getS('f_air_status')||(calcAqi>0?autoStatus(100-calcAqi,50,0):'') },
    people:{ totalVillas,occupied:occupied||null,
      occupancyPct:totalVillas>0?(occupied/totalVillas)*100:null,
      plannedFootfall:getN('f_plan_ft')||null,actualFootfall:getN('f_act_ft')||null,
      events:getN('f_events')||null,
      status:getS('f_p_status')||(occupied>0?'Green':'') },
    shelter:{ plannedTasks:ptasks||null,completedTasks:dtasks||null,
      completionPct:ptasks>0?(dtasks/ptasks)*100:null,
      civilPct:getN('f_civil')||null,landscapePct:getN('f_landscape')||null,
      pestPct:getN('f_pest')||null,
      status:getS('f_sh_status')||(ptasks>0?autoStatus((dtasks/ptasks)*100):'') },
  };

  manualEntries=manualEntries.filter(e=>e.month!==month);
  manualEntries.push(entry);
  manualEntries.sort((a,b)=>a.month.localeCompare(b.month));
  await saveToStorage();

  rebuildDFromManual();
  mergeAndRender(document.getElementById('fileBadge').textContent||'Manual Data');
  renderSavedEntriesList();
  refreshMonthSelects();

  const fb=document.getElementById('saveFeedback');
  fb.classList.add('show');
  setTimeout(()=>fb.classList.remove('show'),2000);
  toast('âœ… '+month+' saved!');
}

function rebuildDFromManual(){
  // For each pillar, convert manual entries to the same schema as excel rows
  const excelRows=key=>D[key].filter(r=>r._src==='excel');

  manualEntries.forEach(entry=>{
    const m=entry.month;
    // ENERGY
    if(entry.energy&&entry.energy.total!=null){
      const e=entry.energy;
      if(!D.energy.find(r=>r.month===m&&r._src==='excel'))
        D.energy=D.energy.filter(r=>!(r.month===m&&r._src==='manual'));
      D.energy=D.energy.filter(r=>!(r.month===m&&r._src==='manual'));
      D.energy.push({month:m,solar:e.solar,eb:e.eb,dg:e.dg,total:e.total,powerFactor:e.powerFactor,status:e.status,_src:'manual'});
    }
    // ENERGY CLUSTER (manual)
    if(entry.energy?.cluster&&Object.keys(entry.energy.cluster).length){
      D.energyCluster=D.energyCluster.filter(r=>!(r.month===m&&r._src==='manual'));
      const clRow={month:m,_src:'manual'};
      Object.assign(clRow,entry.energy.cluster);
      D.energyCluster.push(clRow);
      D.energyCluster.sort((a,b)=>a.month.localeCompare(b.month));
    }
    // ENERGY DAILY (manual)
    if(entry.energy?.daily&&Object.keys(entry.energy.daily).length){
      // Only set if no excel daily data exists (daily is always per month, replace manual only)
      if(!D.energyDaily.some(r=>r._src==='excel')){
        D.energyDaily=D.energyDaily.filter(r=>r._src!=='manual');
        Object.entries(entry.energy.daily).forEach(([day,vals])=>{
          D.energyDaily.push({day:Number(day),eb:vals.eb,solar:vals.solar,_src:'manual'});
        });
        D.energyDaily.sort((a,b)=>a.day-b.day);
      }
    }
    // WATER
    if(entry.water&&entry.water.total!=null){
      const w=entry.water;
      D.water=D.water.filter(r=>!(r.month===m&&r._src==='manual'));
      D.water.push({month:m,borewell:w.borewell,dugWell1:w.dugWell1,dugWell2:w.dugWell2,missionBhag:w.missionBhag,
        total:w.total,stability:w.stability,ph:w.ph,status:w.status,_src:'manual'});
    }
    // FOOD
    if(entry.food&&(entry.food.planned||entry.food.actual)){
      const f=entry.food;
      D.food=D.food.filter(r=>!(r.month===m&&r._src==='manual'));
      D.food.push({month:m,planned:f.planned,actual:f.actual,variance:f.variance,families:f.families,status:f.status,_src:'manual'});
    }
    // EARTH
    if(entry.earth&&(entry.earth.organicProd||entry.earth.recycleProd)){
      const ea=entry.earth;
      D.earth=D.earth.filter(r=>!(r.month===m&&r._src==='manual'));
      if(ea.organicProd)D.earth.push({month:m,wasteType:'Organic Waste',produced:ea.organicProd,reused:ea.organicReused,processed:ea.organicProc,reuseP:ea.reuseP,status:ea.status,_src:'manual'});
      if(ea.recycleProd)D.earth.push({month:m,wasteType:'Recyclable',produced:ea.recycleProd,reused:ea.recycleReused,processed:ea.recycleProc,status:ea.status,_src:'manual'});
    }
    // AIR
    if(entry.air&&entry.air.pm25){
      const a=entry.air;
      D.air=D.air.filter(r=>!(r.month===m&&r._src==='manual'));
      D.air.push({month:m,location:a.location,pm25:a.pm25,pm10:a.pm10,co2:a.co2,aqi:a.aqi,status:a.status,_src:'manual'});
    }
    // PEOPLE
    if(entry.people&&entry.people.occupied!=null){
      const pp=entry.people;
      D.people=D.people.filter(r=>!(r.month===m&&r._src==='manual'));
      D.people.push({month:m,total:pp.totalVillas,occupied:pp.occupied,occupancyPct:pp.occupancyPct,
        plannedFootfall:pp.plannedFootfall,actualFootfall:pp.actualFootfall,status:pp.status,_src:'manual'});
    }
    // SHELTER
    if(entry.shelter&&entry.shelter.plannedTasks!=null){
      const sh=entry.shelter;
      D.shelter=D.shelter.filter(r=>!(r.month===m&&r._src==='manual'));
      D.shelter.push({month:m,planned:sh.plannedTasks,completed:sh.completedTasks,completionPct:sh.completionPct,
        civilPct:sh.civilPct,landscapePct:sh.landscapePct,pestPct:sh.pestPct,status:sh.status,_src:'manual'});
    }
  });

  // Sort only month-keyed pillar arrays
  const monthKeyed=['energy','water','food','earth','air','people','shelter','energyCluster','waterConsumption','waterQuality'];
  for(const k of monthKeyed) if(D[k]) D[k].sort((a,b)=>(a.month||'').localeCompare(b.month||''));
  // Sort energyDaily by day number
  if(D.energyDaily) D.energyDaily.sort((a,b)=>(a.day||0)-(b.day||0));
}

function renderSavedEntriesList(){
  const el=document.getElementById('savedEntriesList');
  if(manualEntries.length===0){el.innerHTML='<div style="font-size:11px;color:var(--text3);font-family:var(--mono)">No entries yet.</div>';return;}
  el.innerHTML=manualEntries.map((e,i)=>`
    <div class="entry-item">
      <div>
        <span class="entry-month">${e.month}</span>
        <span class="entry-source"> Â· Manual</span>
      </div>
      <div style="display:flex;gap:4px;align-items:center">
        <button class="entry-edit" onclick="loadMonthIntoForm('${e.month}')">Edit</button>
        <button class="entry-del" onclick="deleteEntry(${i})" title="Delete">âœ•</button>
      </div>
    </div>`).join('');
}

async function deleteEntry(i){
  manualEntries.splice(i,1);
  await saveToStorage();
  // Clear manual entries from month-keyed arrays
  for(const k of ['energy','water','food','earth','air','people','shelter','energyCluster','waterConsumption','waterQuality']) {
    if(D[k]) D[k]=D[k].filter(r=>r._src!=='manual');
  }
  // energyDaily: keep only excel-sourced rows
  if(D.energyDaily) D.energyDaily=D.energyDaily.filter(r=>r._src!=='manual');
  rebuildDFromManual();
  mergeAndRender(document.getElementById('fileBadge').textContent||'Manual Data');
  renderSavedEntriesList();
  refreshMonthSelects();
  toast('ğŸ—‘ï¸ Entry deleted');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function mergeAndRender(filename){
  rebuildDFromManual();
  document.getElementById('dashboard').style.display='block';
  document.getElementById('drop-screen').style.display='none';
  if(filename) document.getElementById('fileBadge').textContent=filename;

  const allMonths=[...new Set([...D.energy,...D.water,...D.food,...D.people,...D.shelter].map(r=>r.month).filter(Boolean))].sort();
  document.getElementById('periodBadge').textContent=allMonths[allMonths.length-1]||'2026';
  renderAll();
}

function renderAll(){
  renderExecutive();renderEnergy();renderWater();renderFood();
  renderEarth();renderAir();renderPeople();renderShelter();
}

// Chart helpers
function mkDonut(id,labels,data,colors){
  if(charts[id])charts[id].destroy();
  const ctx=document.getElementById(id);if(!ctx)return;
  charts[id]=new Chart(ctx,{type:'doughnut',
    data:{labels,datasets:[{data,backgroundColor:colors,borderWidth:0,hoverOffset:3}]},
    options:{responsive:true,maintainAspectRatio:false,cutout:'72%',
      plugins:{legend:{position:'bottom',labels:{boxWidth:8,padding:9}},
        tooltip:{callbacks:{label:c=>` ${c.label}: ${Number(c.raw||0).toLocaleString()}`}}}}});
}
function mkBar(id,labels,datasets,opts={}){
  if(charts[id])charts[id].destroy();
  const ctx=document.getElementById(id);if(!ctx)return;
  charts[id]=new Chart(ctx,{type:'bar',data:{labels,datasets},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:datasets.length>1,labels:{boxWidth:8,padding:9}}},
      scales:{x:{grid:{color:'#1a3028'},ticks:{color:'#6a9a80'}},y:{grid:{color:'#1a3028'},ticks:{color:'#6a9a80'},beginAtZero:true}},...opts}});
}
function mkLine(id,labels,datasets,opts={}){
  if(charts[id])charts[id].destroy();
  const ctx=document.getElementById(id);if(!ctx)return;
  charts[id]=new Chart(ctx,{type:'line',data:{labels,datasets},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:datasets.length>1,labels:{boxWidth:8,padding:9}}},
      scales:{x:{grid:{color:'#1a3028'},ticks:{color:'#6a9a80'}},y:{grid:{color:'#1a3028'},ticks:{color:'#6a9a80'},beginAtZero:true}},...opts}});
}

// Utilities
function fmt(n,dec=0){return n==null||isNaN(n)?'â€”':Number(n).toLocaleString(undefined,{maximumFractionDigits:dec,minimumFractionDigits:dec});}
function pct(n){return n==null||isNaN(n)?'â€”':Math.round(n)+'%';}
function tagHtml(s){
  const l=(s||'').toLowerCase();
  if(l.includes('green')||l.includes('âœ…'))return'<span class="tag tag-green">ğŸŸ¢ Green</span>';
  if(l.includes('amber'))return'<span class="tag tag-amber">ğŸŸ¡ Amber</span>';
  if(l.includes('red'))return'<span class="tag tag-red">ğŸ”´ Red</span>';
  return'<span class="tag tag-grey">âšª '+s+'</span>';
}
function srcTag(s){return s==='manual'?'<span class="tag tag-blue">âœï¸ Manual</span>':'<span class="tag tag-grey">ğŸ“Š Excel</span>';}
function latestOf(arr){return arr&&arr.length?arr[arr.length-1]:{};}
function getMths(arr){return[...new Set((arr||[]).map(r=>r.month||'').filter(Boolean))];}
function kpiCard(icon,label,value,unit,sub,accent,delay=0){
  return`<div class="kpi-card" style="--card-accent:${accent};animation-delay:${delay}s">
    <div class="kpi-icon">${icon}</div><div class="kpi-label">${label}</div>
    <div class="kpi-value">${value}</div><div class="kpi-unit">${unit}</div>
    <div class="kpi-sub">${sub}</div></div>`;
}
function buildMF(cid,arr,key,cb){
  const c=document.getElementById(cid);if(!c)return;
  const ms=getMths(arr);
  if(!selMonth[key]||!ms.includes(selMonth[key]))selMonth[key]=ms[ms.length-1]||'';
  c.innerHTML=ms.map(m=>`<button class="month-btn${m===selMonth[key]?' active':''}" onclick="smb('${key}','${m}','${cid}')">${m}</button>`).join('');
}
function smb(key,month,cid){
  selMonth[key]=month;
  document.querySelectorAll(`#${cid} .month-btn`).forEach(b=>{b.classList.toggle('active',b.textContent===month);});
  if(key==='energy')renderEnergy();
  if(key==='water')renderWater();
  if(key==='food')renderFood();
  if(key==='people')renderPeople();
  if(key==='shelter')renderShelter();
}
function progRow(label,val,total,color){
  const p=total>0?Math.round(((val||0)/total)*100):0;
  return`<div class="progress-row"><div class="progress-label">${label}<span>${fmt(val)||'â€”'} KL (${p}%)</span></div>
    <div class="progress-bg"><div class="progress-fill" style="width:${p}%;background:${color}"></div></div></div>`;
}

// â”€â”€ EXECUTIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderExecutive(){
  const eRow=latestOf(D.energy),wRow=latestOf(D.water),fRow=latestOf(D.food);
  const pRow=latestOf(D.people),sRow=latestOf(D.shelter),airRow=latestOf(D.air);
  const earthRow=latestOf(D.earth.filter(r=>r.wasteType==='Organic Waste')||D.earth);

  const pillarDefs=[
    {emoji:'âš¡',name:'Energy',val:eRow.total?fmt(eRow.total)+' kWh':'â€”',bar:eRow.solar&&eRow.total?Math.min((eRow.solar/eRow.total)*100,100):20,color:C.yellow,status:eRow.status,page:'energy'},
    {emoji:'ğŸ’§',name:'Water',val:wRow.total?fmt(wRow.total)+' KL':'â€”',bar:Math.min(wRow.stability||0,100),color:C.blue,status:wRow.status,page:'water'},
    {emoji:'ğŸŒ±',name:'Food',val:fRow.actual?fmt(fRow.actual)+' kg':'â€”',bar:fRow.planned>0?Math.min((fRow.actual/fRow.planned)*100,100):0,color:C.green,status:fRow.status,page:'food'},
    {emoji:'ğŸŒ',name:'Earth',val:earthRow.reuseP?pct(earthRow.reuseP)+' reuse':'â€”',bar:Math.min(earthRow.reuseP||0,100),color:'#7ec845',status:earthRow.status,page:'earth'},
    {emoji:'ğŸ’¨',name:'Air',val:airRow.aqi?'AQI '+Math.round(airRow.aqi):'â€”',bar:airRow.aqi?Math.max(0,100-airRow.aqi):0,color:'#94d1e8',status:airRow.aqi<=100?'Green':'Amber',page:'air'},
    {emoji:'ğŸ‘¥',name:'People',val:pRow.occupied?pRow.occupied+' occ':'â€”',bar:pRow.total>0?(pRow.occupied/pRow.total)*100:0,color:C.purple,status:pRow.status,page:'people'},
    {emoji:'ğŸ ',name:'Shelter',val:sRow.civilPct?pct(sRow.civilPct)+' civil':'â€”',bar:Math.min(sRow.civilPct||0,100),color:C.orange,status:sRow.status,page:'shelter'},
  ];

  const pg=document.getElementById('pillarsGrid');pg.innerHTML='';
  pillarDefs.forEach((p,i)=>{
    pg.innerHTML+=`<div class="pillar-card" style="animation-delay:${i*0.05}s" onclick="goPage('${p.page}')">
      <span class="pillar-emoji">${p.emoji}</span><div class="pillar-name">${p.name}</div>
      <div class="pillar-score" style="color:${p.color}">${p.val}</div>
      <div class="pillar-bar-bg"><div class="pillar-bar-fill" id="pb${i}" style="width:0%;background:${p.color}"></div></div>
      <div class="pillar-status">${p.status||'No data'}</div></div>`;
    setTimeout(()=>{const el=document.getElementById('pb'+i);if(el)el.style.width=p.bar+'%';},250+i*40);
  });

  const eTot=(eRow.dg||0)+(eRow.eb||0)+(eRow.solar||0);
  mkDonut('execEDonut',['DG','EB','Solar'],[eRow.dg||0,eRow.eb||0,eRow.solar||0],[C.yellow,C.blue,C.green]);
  document.getElementById('execEVal').textContent=fmt(eRow.total||eTot);
  document.getElementById('execELbl').textContent=eRow.month||'';
  mkDonut('execWDonut',['Dug Well 1','Borewell','Dug Well 2','Mission Bhag.'],[wRow.dugWell1||0,wRow.borewell||0,wRow.dugWell2||0,wRow.missionBhag||0],[C.blue,C.purple,C.green,C.amber]);
  document.getElementById('execWVal').textContent=fmt(wRow.total);
  document.getElementById('execWLbl').textContent=wRow.month||'';
  mkBar('execFoodBar',D.food.map(r=>r.month),[
    {label:'Planned (kg)',data:D.food.map(r=>r.planned||0),backgroundColor:C.grey,borderRadius:3,borderWidth:0},
    {label:'Actual (kg)',data:D.food.map(r=>r.actual||0),backgroundColor:C.green,borderRadius:3,borderWidth:0},
  ]);
  document.getElementById('execSummaryBody').innerHTML=[
    ['âš¡ Energy',eRow.total?fmt(eRow.total)+' kWh':'â€”',eRow.status,eRow._src],
    ['ğŸ’§ Water',wRow.total?fmt(wRow.total)+' KL':'â€”',wRow.status,wRow._src],
    ['ğŸŒ± Food',fRow.actual?fmt(fRow.actual)+' kg ('+pct(fRow.planned>0?(fRow.actual/fRow.planned)*100:null)+' of plan)':'â€”',fRow.status,fRow._src],
    ['ğŸŒ Earth',earthRow.reuseP?pct(earthRow.reuseP)+' reuse rate':'â€”',earthRow.status,earthRow._src],
    ['ğŸ’¨ Air',airRow.aqi?'AQI '+Math.round(airRow.aqi)+(airRow.location?' @ '+airRow.location:''):'â€”',airRow.aqi<=100?'Green':'Amber',airRow._src],
    ['ğŸ‘¥ People',pRow.total?pRow.occupied+'/'+pRow.total+' villas':'â€”',pRow.status,pRow._src],
    ['ğŸ  Shelter',sRow.planned?sRow.completed+'/'+sRow.planned+' tasks':'â€”',sRow.status,sRow._src],
  ].map(([p,v,st,src])=>`<tr><td>${p}</td><td>${v}</td><td>${tagHtml(st)}</td><td>${srcTag(src)}</td></tr>`).join('');
}

// â”€â”€ ENERGY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderEnergy(){
  buildMF('energyMF',D.energy,'energy',renderEnergy);
  const sel=selMonth['energy']||latestOf(D.energy).month;
  const row=D.energy.find(r=>r.month===sel)||latestOf(D.energy);
  const tot=row.total||(row.solar||0)+(row.eb||0)+(row.dg||0);
  document.getElementById('energyKpis').innerHTML=
    kpiCard('âš¡','Total Power',fmt(tot),'kWh â€” '+row.month,tagHtml(row.status),C.yellow,0)+
    kpiCard('â˜€ï¸','Solar',fmt(row.solar),'kWh',tot>0?`<span class="tag tag-green">${pct((row.solar/tot)*100)} share</span>`:'',C.green,0.04)+
    kpiCard('ğŸ”Œ','EB',fmt(row.eb),'kWh',tot>0?`<span class="tag tag-grey">${pct((row.eb/tot)*100)} share</span>`:'',C.blue,0.08)+
    kpiCard('ğŸ­','DG',fmt(row.dg),'kWh',tot>0?`<span class="tag tag-amber">${pct((row.dg/tot)*100)} share</span>`:'',C.amber,0.12)+
    kpiCard('ğŸ”‹','Power Factor',row.powerFactor?Number(row.powerFactor).toFixed(2):'â€”','',row.powerFactor>=0.95?'<span class="tag tag-green">Excellent</span>':'',C.green,0.16)+
    kpiCard('ğŸ“Œ','Source',srcTag(row._src).replace(/<[^>]+>/g,''),'','',C.grey,0.2);
  mkDonut('eDonut',['DG','EB','Solar'],[row.dg||0,row.eb||0,row.solar||0],[C.yellow,C.blue,C.green]);
  document.getElementById('eTot').textContent=fmt(tot);
  mkLine('eTrend',D.energy.map(r=>r.month),[
    {label:'Total kWh',data:D.energy.map(r=>r.total||(r.solar||0)+(r.eb||0)+(r.dg||0)),borderColor:C.yellow,backgroundColor:'rgba(247,201,72,0.07)',fill:true,tension:0.4,pointRadius:3},
    {label:'Solar',data:D.energy.map(r=>r.solar||0),borderColor:C.green,backgroundColor:'transparent',tension:0.4,pointRadius:3},
  ],{plugins:{legend:{display:true}}});
  document.getElementById('energyTb').innerHTML=D.energy.map(r=>{
    const t=r.total||(r.solar||0)+(r.eb||0)+(r.dg||0);
    return`<tr><td>${r.month}</td><td class="num">${fmt(r.solar)}</td><td class="num">${fmt(r.eb)}</td><td class="num">${fmt(r.dg)}</td><td class="num">${fmt(t)}</td><td class="num">${r.powerFactor?Number(r.powerFactor).toFixed(2):'â€”'}</td><td>${tagHtml(r.status)}</td></tr>`;
  }).join('');

  // â”€â”€ TABLE 3: Clusterwise â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const clusters=['RP','MRP','GP','VP','MDP','CP','CHP','SP','TP'];
  const clColors=[C.yellow,C.green,C.blue,C.purple,C.amber,C.orange,'#94d1e8','#7ec845','#e87d7d'];
  const clData=D.energyCluster||[];
  // Show latest month with data
  const latestCl=clData.find(r=>clusters.some(c=>r[c]>0))||clData[0]||{};
  document.getElementById('clusterMonthLbl').textContent=latestCl.month||'';
  const clVals=clusters.map(c=>latestCl[c]||0);
  const clTot=clVals.reduce((a,b)=>a+b,0);
  document.getElementById('clusterTot').textContent=fmt(clTot);
  mkBar('clusterBar',clusters,[{
    label:'Actual kWh',data:clVals,
    backgroundColor:clColors,borderRadius:4,borderWidth:0
  }]);
  mkDonut('clusterDonut',clusters,clVals,clColors);
  document.getElementById('clusterTb').innerHTML=clData.length
    ? clData.map(r=>`<tr><td>${r.month}</td>${clusters.map(c=>`<td class="num">${fmt(r[c])}</td>`).join('')}</tr>`).join('')
    : `<tr><td colspan="10" style="text-align:center;color:var(--text3);padding:20px">Load the Excel file to see clusterwise data</td></tr>`;

  // â”€â”€ TABLE 4: Daily â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const daily=D.energyDaily||[];
  const dayLabels=daily.map(d=>`Day ${d.day}`);
  mkBar('dailyEbBar',dayLabels,[{
    label:'EB (kWh)',data:daily.map(d=>d.eb||0),
    backgroundColor:'rgba(77,184,255,0.7)',borderRadius:3,borderWidth:0
  }]);
  mkBar('dailySolarBar',dayLabels,[{
    label:'Solar (kWh)',data:daily.map(d=>d.solar||0),
    backgroundColor:'rgba(247,201,72,0.75)',borderRadius:3,borderWidth:0
  }]);
  document.getElementById('dailyTb').innerHTML=daily.length
    ? daily.map(d=>{
        const combined=(d.eb||0)+(d.solar||0);
        return`<tr><td>${d.day}</td><td class="num">${fmt(d.eb)}</td><td class="num">${fmt(d.solar)}</td><td class="num">${fmt(combined)}</td></tr>`;
      }).join('')
    : `<tr><td colspan="4" style="text-align:center;color:var(--text3);padding:20px">Load the Excel file to see daily data</td></tr>`;
}

// â”€â”€ WATER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderWater(){
  buildMF('waterMF',D.water,'water',renderWater);
  const sel=selMonth['water']||latestOf(D.water).month;
  const row=D.water.find(r=>r.month===sel)||latestOf(D.water);
  document.getElementById('waterKpis').innerHTML=
    kpiCard('ğŸ’§','Total Supply',fmt(row.total),'KL â€” '+row.month,tagHtml(row.status),C.blue,0)+
    kpiCard('ğŸ“Š','Stability',pct(row.stability),'',row.stability>=90?'<span class="tag tag-green">Excellent</span>':row.stability>=70?'<span class="tag tag-amber">Monitor</span>':'<span class="tag tag-red">Issue</span>',C.green,0.04)+
    kpiCard('ğŸš°','Dug Well 1',fmt(row.dugWell1),'KL','',C.blue,0.08)+
    kpiCard('ğŸª£','Borewell',fmt(row.borewell),'KL','',C.purple,0.12);
  mkDonut('wDonut',['Dug Well 1','Borewell','Dug Well 2','Mission Bhag.'],[row.dugWell1||0,row.borewell||0,row.dugWell2||0,row.missionBhag||0],[C.blue,C.purple,C.green,C.amber]);
  document.getElementById('wTot').textContent=fmt(row.total);
  document.getElementById('wSourceDetail').innerHTML=(row.total>0)?
    progRow('Dug Well 1',row.dugWell1,row.total,C.blue)+
    progRow('Borewell',row.borewell,row.total,C.purple)+
    progRow('Dug Well 2',row.dugWell2,row.total,C.green)+
    progRow('Mission Bhagirath',row.missionBhag,row.total,C.amber):'<div style="color:var(--text3);font-size:12px;padding:8px">No water data for this month.</div>';
  mkLine('wTrend',D.water.map(r=>r.month),[
    {label:'Total KL',data:D.water.map(r=>r.total||0),borderColor:C.blue,backgroundColor:'rgba(77,184,255,0.07)',fill:true,tension:0.4,pointRadius:3},
  ]);
  document.getElementById('waterTb').innerHTML=D.water.map(r=>`<tr>
    <td>${r.month}</td><td class="num">${fmt(r.borewell)}</td><td class="num">${fmt(r.dugWell1)}</td>
    <td class="num">${fmt(r.dugWell2)}</td><td class="num">${fmt(r.missionBhag)}</td>
    <td class="num">${fmt(r.total)}</td><td class="num">${pct(r.stability)}</td><td>${tagHtml(r.status)}</td></tr>`).join('');

  // â”€â”€ TABLE 2: Consumption Balance â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const wc=D.waterConsumption||[];
  // Get months that have actual data, default to first available
  const wcMonths=[...new Set(wc.map(r=>r.month))];
  const wcSelMonth=wcMonths.includes(sel)?sel:(wcMonths[0]||'');
  document.getElementById('consumMonthLbl').textContent=wcSelMonth;
  const wcRows=wc.filter(r=>r.month===wcSelMonth);
  // Bar + donut by category
  const catColors={'Houses':C.purple,'Amenities':C.blue,'Irrigation':C.green,'Other Services':C.amber};
  const catLabels=wcRows.map(r=>r.location||r.category||'â€”');
  const catActuals=wcRows.map(r=>r.actual||0);
  const catTotal=catActuals.reduce((a,b)=>a+b,0);
  document.getElementById('consumTot').textContent=fmt(catTotal);
  mkBar('consumBar',catLabels,[
    {label:'Planned (KL)',data:wcRows.map(r=>r.planned||0),backgroundColor:C.grey,borderRadius:3,borderWidth:0},
    {label:'Actual (KL)',data:catActuals,backgroundColor:wcRows.map(r=>catColors[r.category]||C.blue),borderRadius:3,borderWidth:0},
  ]);
  mkDonut('consumDonut',catLabels,catActuals,wcRows.map(r=>catColors[r.category]||C.blue));
  document.getElementById('consumTb').innerHTML=wc.length
    ? wc.map(r=>{
        const vSign=(r.variance||0)>=0;
        return`<tr>
          <td>${r.month}</td><td>${r.category||'â€”'}</td><td>${r.location||'â€”'}</td>
          <td class="num">${fmt(r.planned)}</td><td class="num">${fmt(r.actual)}</td>
          <td class="num" style="color:${vSign?C.green:C.amber}">${fmt(r.variance)}</td>
          <td class="num" style="color:${vSign?C.green:C.amber}">${r.variancePct!=null?Number(r.variancePct*100).toFixed(0)+'%':'â€”'}</td>
          <td>${tagHtml(r.status)}</td></tr>`;
      }).join('')
    : `<tr><td colspan="8" style="text-align:center;color:var(--text3);padding:20px">Load the Excel file to see consumption data</td></tr>`;

  // â”€â”€ TABLE 3: Water Quality â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const wq=D.waterQuality||[];
  const wqMonths=[...new Set(wq.map(r=>r.month))];
  const wqSelMonth=wqMonths.includes(sel)?sel:(wqMonths[0]||'');
  document.getElementById('qualMonthLbl').textContent=wqSelMonth;
  const wqRows=wq.filter(r=>r.month===wqSelMonth);
  // pH bar
  const phTypes=wqRows.map(r=>r.waterType||'â€”');
  const phVals=wqRows.map(r=>r.ph||0);
  mkBar('phBar',phTypes,[{
    label:'pH Level',data:phVals,
    backgroundColor:wqRows.map(r=>r.ph<6.5||r.ph>8.5?C.red:r.ph<7||r.ph>8?C.amber:C.green),
    borderRadius:4,borderWidth:0
  }]);
  // Compliance donut
  const compliant=wqRows.filter(r=>(r.status||'').toLowerCase().includes('green')).length;
  const nonCompliant=wqRows.length-compliant;
  document.getElementById('qualCompliance').textContent=wqRows.length>0?compliant+'/'+wqRows.length:'â€”';
  mkDonut('qualDonut',['Compliant','Non-Compliant'],[compliant,nonCompliant],[C.green,C.red]);
  document.getElementById('qualityTb').innerHTML=wq.length
    ? wq.map(r=>`<tr>
        <td>${r.month}</td><td>${r.waterType||'â€”'}</td>
        <td class="num" style="color:${r.ph&&(r.ph<6.5||r.ph>8.5)?C.red:C.text2}">${r.ph!=null?Number(r.ph).toFixed(2):'â€”'}</td>
        <td class="num">${fmt(r.tds)}</td><td class="num">${fmt(r.turbidity)}</td>
        <td class="num">${fmt(r.chlorine)}</td>
        <td style="font-size:11px">${r.ecoli||'â€”'}</td>
        <td class="num">${r.compliancePct!=null?fmt(r.compliancePct)+'%':'â€”'}</td>
        <td>${tagHtml(r.status)}</td></tr>`).join('')
    : `<tr><td colspan="9" style="text-align:center;color:var(--text3);padding:20px">Load the Excel file to see quality data</td></tr>`;
}

// â”€â”€ FOOD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFood(){
  buildMF('foodMF',D.food,'food',renderFood);
  const sel=selMonth['food']||latestOf(D.food).month;
  const row=D.food.find(r=>r.month===sel)||latestOf(D.food);
  const ach=row.planned>0?Math.round((row.actual/row.planned)*100):0;
  document.getElementById('foodKpis').innerHTML=
    kpiCard('ğŸ¥¬','Actual Yield',fmt(row.actual),'kg â€” '+row.month,tagHtml(row.status),C.green,0)+
    kpiCard('ğŸ“‹','Planned',fmt(row.planned),'kg','',C.grey,0.04)+
    kpiCard('ğŸ“‰','Variance',fmt(row.variance),'kg',row.variance>=0?'<span class="tag tag-green">Surplus</span>':'<span class="tag tag-amber">Shortfall</span>',row.variance>=0?C.green:C.amber,0.08)+
    kpiCard('ğŸ‘¨â€ğŸ‘©â€ğŸ‘§','Families',fmt(row.families),'served','',C.purple,0.12);
  document.getElementById('fPct').textContent=ach+'%';
  mkBar('fBar',D.food.map(r=>r.month),[
    {label:'Planned',data:D.food.map(r=>r.planned||0),backgroundColor:C.grey,borderRadius:3,borderWidth:0},
    {label:'Actual',data:D.food.map(r=>r.actual||0),backgroundColor:C.green,borderRadius:3,borderWidth:0},
  ]);
  mkDonut('fGauge',['Achieved','Remaining'],[ach,Math.max(0,100-ach)],[C.green,'#1a3028']);
  document.getElementById('foodTb').innerHTML=D.food.map(r=>{
    const a=r.planned>0?Math.round((r.actual/r.planned)*100):0;
    return`<tr><td>${r.month}</td><td class="num">${fmt(r.planned)}</td><td class="num">${fmt(r.actual)}</td>
    <td class="num" style="color:${(r.variance||0)>=0?C.green:C.amber}">${fmt(r.variance)}</td>
    <td class="num">${a}%</td><td class="num">${fmt(r.families)}</td><td>${tagHtml(r.status)}</td></tr>`;
  }).join('');
}

// â”€â”€ EARTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderEarth(){
  const ed=D.earth||[];
  const organic=ed.filter(r=>r.wasteType&&r.wasteType.toLowerCase().includes('organic'));
  const row=latestOf(organic)||latestOf(ed);
  document.getElementById('earthKpis').innerHTML=
    kpiCard('â™»ï¸','Produced',fmt(row.produced),'kg â€” '+row.month,tagHtml(row.status),C.green,0)+
    kpiCard('ğŸŒ¿','Reused',fmt(row.reused),'kg',row.reuseP?`<span class="tag tag-${row.reuseP>=85?'green':row.reuseP>=70?'amber':'red'}">${pct(row.reuseP)}</span>`:'',C.green,0.04)+
    kpiCard('ğŸ­','Processed',fmt(row.processed),'kg','','#7ec845',0.08);
  const latestM=row.month;
  const mRows=ed.filter(r=>r.month===latestM);
  mkBar('eaBar',mRows.map(r=>r.wasteType||'â€”'),[
    {label:'Produced',data:mRows.map(r=>r.produced||0),backgroundColor:C.amber,borderRadius:3,borderWidth:0},
    {label:'Reused',data:mRows.map(r=>r.reused||0),backgroundColor:C.green,borderRadius:3,borderWidth:0},
  ]);
  const mSummary=Object.values(ed.reduce((acc,r)=>{if(!acc[r.month])acc[r.month]={month:r.month,reuseP:r.reuseP};return acc;},{}));
  mkLine('eaTrend',mSummary.map(r=>r.month),[
    {label:'Reuse%',data:mSummary.map(r=>r.reuseP||0),borderColor:C.green,backgroundColor:'rgba(45,255,138,0.07)',fill:true,tension:0.4,pointRadius:3},
  ]);
  document.getElementById('earthTb').innerHTML=ed.map(r=>`<tr>
    <td>${r.month}</td><td>${r.wasteType||'â€”'}</td><td class="num">${fmt(r.produced)}</td>
    <td class="num">${fmt(r.reused)}</td><td class="num">${fmt(r.processed)}</td>
    <td class="num">${pct(r.reuseP)}</td><td>${tagHtml(r.status)}</td></tr>`).join('');
}

// â”€â”€ AIR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAir(){
  const ad=D.air||[];const row=latestOf(ad);
  document.getElementById('airKpis').innerHTML=
    kpiCard('ğŸ­','Avg PM2.5',row.pm25?Number(row.pm25).toFixed(1):'â€”','Âµg/mÂ³',row.pm25<=12?'<span class="tag tag-green">Good</span>':row.pm25<=35?'<span class="tag tag-amber">Moderate</span>':'<span class="tag tag-red">High</span>',C.blue,0)+
    kpiCard('ğŸ’¨','Avg AQI',row.aqi?Math.round(row.aqi):'â€”','0â€“500',row.aqi<=50?'<span class="tag tag-green">Good</span>':row.aqi<=100?'<span class="tag tag-amber">Moderate</span>':'<span class="tag tag-red">Unhealthy</span>',C.blue,0.04)+
    kpiCard('ğŸ“','Location',row.location||'â€”','this month','',C.green,0.08)+
    kpiCard('âœ…','Compliance',row.aqi?row.aqi<=100?'Yes':'No':'â€”','AQI â‰¤ 100',row.aqi<=100?'<span class="tag tag-green">Compliant</span>':'<span class="tag tag-red">Non-compliant</span>',C.green,0.12);
  mkLine('airPm',ad.map(r=>r.month),[
    {label:'PM2.5',data:ad.map(r=>r.pm25||0),borderColor:C.blue,backgroundColor:'rgba(77,184,255,0.07)',fill:true,tension:0.4,pointRadius:3},
    {label:'Safe (60)',data:ad.map(()=>60),borderColor:C.grey,borderDash:[4,4],pointRadius:0,borderWidth:1},
  ],{plugins:{legend:{display:true}}});
  mkLine('airAqi',ad.map(r=>r.month),[
    {label:'AQI',data:ad.map(r=>r.aqi?Math.round(r.aqi):0),borderColor:C.amber,backgroundColor:'rgba(255,179,64,0.07)',fill:true,tension:0.4,pointRadius:3},
    {label:'Limit (100)',data:ad.map(()=>100),borderColor:C.red,borderDash:[4,4],pointRadius:0,borderWidth:1},
  ],{plugins:{legend:{display:true}}});
  document.getElementById('airTb').innerHTML=ad.map(r=>`<tr>
    <td>${r.month}</td><td>${r.location||'â€”'}</td><td class="num">${r.pm25?Number(r.pm25).toFixed(1):'â€”'}</td>
    <td class="num">${r.aqi?Math.round(r.aqi):'â€”'}</td>
    <td>${r.aqi?r.aqi<=50?'<span class="tag tag-green">Good</span>':r.aqi<=100?'<span class="tag tag-amber">Moderate</span>':'<span class="tag tag-red">Unhealthy</span>':'<span class="tag tag-grey">âšª Pending</span>'}</td></tr>`).join('');
}

// â”€â”€ PEOPLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPeople(){
  buildMF('peopleMF',D.people,'people',renderPeople);
  const sel=selMonth['people']||latestOf(D.people).month;
  const row=D.people.find(r=>r.month===sel)||latestOf(D.people);
  const occ=row.total>0?((row.occupied/row.total)*100).toFixed(1):'â€”';
  document.getElementById('peopleKpis').innerHTML=
    kpiCard('ğŸ˜ï¸','Total Villas',fmt(row.total),'community total','',C.purple,0)+
    kpiCard('âœ…','Occupied',fmt(row.occupied),'villas â€” '+row.month,`<span class="tag tag-${occ>=50?'green':'amber'}">${occ}% occ.</span>`,C.green,0.04)+
    kpiCard('ğŸ”‘','Vacant',fmt((row.total||0)-(row.occupied||0)),'villas','',C.grey,0.08)+
    kpiCard('ğŸš¶','Actual Footfall',fmt(row.actualFootfall),'this month',tagHtml(row.status),C.blue,0.12)+
    kpiCard('ğŸ“‹','Planned Footfall',fmt(row.plannedFootfall),'this month','',C.grey,0.16);
  document.getElementById('pPct').textContent=occ+'%';
  mkDonut('pDonut',['Occupied','Vacant'],[row.occupied||0,Math.max(0,(row.total||0)-(row.occupied||0))],[C.purple,C.grey]);
  mkLine('pTrend',D.people.map(r=>r.month),[
    {label:'Occupancy%',data:D.people.map(r=>r.total>0?((r.occupied/r.total)*100):0),borderColor:C.purple,backgroundColor:'rgba(176,125,255,0.07)',fill:true,tension:0.4,pointRadius:3},
  ]);
  document.getElementById('peopleTb').innerHTML=D.people.map(r=>{
    const o=r.total>0?((r.occupied/r.total)*100).toFixed(1):0;
    return`<tr><td>${r.month}</td><td class="num">${fmt(r.total)}</td><td class="num">${fmt(r.occupied)}</td>
    <td class="num">${o}%</td><td class="num">${fmt(r.plannedFootfall)}</td><td class="num">${fmt(r.actualFootfall)}</td><td>${tagHtml(r.status)}</td></tr>`;
  }).join('');
}

// â”€â”€ SHELTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderShelter(){
  buildMF('shelterMF',D.shelter,'shelter',renderShelter);
  const sel=selMonth['shelter']||latestOf(D.shelter).month;
  const row=D.shelter.find(r=>r.month===sel)||latestOf(D.shelter);
  const cp=row.planned>0?Math.round((row.completed/row.planned)*100):0;
  document.getElementById('shelterKpis').innerHTML=
    kpiCard('ğŸ“‹','Planned Tasks',fmt(row.planned),row.month,tagHtml(row.status),C.yellow,0)+
    kpiCard('âœ…','Completed',fmt(row.completed),'tasks',`<span class="tag tag-${cp>=90?'green':cp>=60?'amber':'red'}">${cp}% done</span>`,cp>=90?C.green:C.amber,0.04)+
    kpiCard('ğŸ—ï¸','Civil Infra',pct(row.civilPct),'completion','',C.amber,0.08)+
    kpiCard('ğŸŒ¿','Landscape',pct(row.landscapePct),'completion','',C.green,0.12)+
    kpiCard('ğŸª²','Pest Mgmt',pct(row.pestPct),'completion','',C.blue,0.16);
  mkBar('shCat',['Civil Infra','Landscape','Pest Mgmt'],[
    {label:'%',data:[row.civilPct||0,row.landscapePct||0,row.pestPct||0],backgroundColor:[C.amber,C.green,C.blue],borderRadius:3,borderWidth:0},
  ]);
  mkLine('shTrend',D.shelter.map(r=>r.month),[
    {label:'Overall%',data:D.shelter.map(r=>r.planned>0?Math.round((r.completed/r.planned)*100):0),borderColor:C.orange,backgroundColor:'rgba(255,156,91,0.07)',fill:true,tension:0.4,pointRadius:3},
    {label:'Civil%',data:D.shelter.map(r=>r.civilPct||0),borderColor:C.amber,backgroundColor:'transparent',tension:0.4,pointRadius:3},
  ],{plugins:{legend:{display:true}}});
  document.getElementById('shelterTb').innerHTML=D.shelter.map(r=>{
    const c=r.planned>0?Math.round((r.completed/r.planned)*100):0;
    return`<tr><td>${r.month}</td><td class="num">${fmt(r.planned)}</td><td class="num">${fmt(r.completed)}</td>
    <td class="num">${c}%</td><td class="num">${pct(r.civilPct)}</td><td class="num">${pct(r.landscapePct)}</td>
    <td class="num">${pct(r.pestPct)}</td><td>${tagHtml(r.status)}</td></tr>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NAV
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showPage(id,el){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('page-'+id).classList.add('active');
  if(el)el.classList.add('active');
}
function goPage(name){
  const idx=['executive','energy','water','food','earth','air','people','shelter'].indexOf(name);
  if(idx>=0){const tabs=document.querySelectorAll('.nav-tab');showPage(name,tabs[idx]);}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let toastTimer;
function toast(msg,err=false){
  const el=document.getElementById('toast');
  el.textContent=msg;
  el.style.borderColor=err?'var(--red)':'var(--accent)';
  el.style.color=err?'var(--red)':'var(--accent)';
  el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>el.classList.remove('show'),3000);
}
</script>


</body></html>